{% extends "layouts/base.html" %}

{% block title %} إدارة أنواع المستندات {% endblock %} 

{% block content %}


{% block title2 %}  
إدارة أنواع المستندات
{% endblock %} 


<!-- Specific Page CSS goes HERE  -->

<!-- [ Main Content ] start -->
<section class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ breadcrumb ] start -->
        
        <!-- [ breadcrumb ] end -->
        
        <!-- [ Main Content ] start -->
        <div class="row">
            <!-- [ basic-table ] start -->
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3" dir="rtl">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-primary d-flex align-items-center" onclick="openAddModal()">
                                <i class="feather icon-plus me-2"></i>
                                إضافة نوع جديد
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                      
                        <div class="table-responsive">
                            <table 
                                id="documentTypesTable"
                                data-toggle="table"
                                data-url="{{ url_for('documents_blueprint.getdocument_types') }}"
                                data-pagination="true"
                                data-search="true"
                                data-search-align="right"
                                data-locale="ar-SA"
                                data-page-size="10"
                                data-page-list="[10, 25, 50, 100]"
                                data-show-refresh="true"
                                data-show-columns="true"
                                data-toolbar=".toolbar"
                                dir="rtl">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th data-field="id" data-sortable="true" data-align="center">#</th>
                                        <th data-field="name" data-sortable="true" data-align="right">اسم النوع</th>
                                        <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents" data-align="center">الإجراءات</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</section>
<!-- [ Main Content ] end -->

<!-- Modal: إضافة -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <form id="addForm" onsubmit="submitAddForm(event)">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">إضافة نوع مستند</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-gray-700">اسم النوع</label>
                        <input name="name"  id="add_name" class="form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="أدخل اسم نوع المستند" required>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-gray-50">
                    <button type="submit" class="btn btn-primary px-4" id="addSubmitBtn">
                        <span id="addButtonText">حفظ</span>
                        <div id="addSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></div>
                    </button>
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: تعديل -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <form id="editForm" onsubmit="submitEditForm(event)">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">تعديل نوع المستند</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" name="id" id="id">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-gray-700">اسم النوع</label>
                        <input name="name" id="edit_name" class="form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="أدخل اسم نوع المستند" required>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-gray-50">
                    <button type="submit" class="btn btn-success px-4" id="editSubmitBtn">
                        <span id="editButtonText">تحديث</span>
                        <div id="editSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></div>
                    </button>
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// تهيئة جدول Bootstrap Table
function operateFormatter(value, row, index) {
    return [
        `<button class="btn btn-sm btn-outline-warning me-1" title="تعديل">
            <i class="fas fa-edit"></i>
        </button>`
    ].join('');
}

window.operateEvents = {
    'click .btn-outline-warning': function (e, value, row, index) {
        openEditModal(row.id, row.name);
    }
};

// تنسيق التاريخ
function dateFormatter(value, row, index) {
    if (!value) return '-';
    return new Date(value).toLocaleDateString('ar-SA');
}

// إظهار رسالة SweetAlert
function showAlert(icon, title, text) {
    Swal.fire({
        icon: icon,
        title: title,
        text: text,
        confirmButtonText: 'موافق',
        confirmButtonColor: '#3085d6',
    });
}

// إظهار/إخفاء مؤشر التحميل
function toggleLoading(show, type = 'table') {
    if (type === 'table') {
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = show ? 'block' : 'none';
    } else if (type === 'add') {
        const spinner = document.getElementById('addSpinner');
        const buttonText = document.getElementById('addButtonText');
        const submitBtn = document.getElementById('addSubmitBtn');
        
        if (show) {
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'جاري الحفظ...';
            submitBtn.disabled = true;
        } else {
            spinner.style.display = 'none';
            buttonText.textContent = 'حفظ';
            submitBtn.disabled = false;
        }
    } else if (type === 'edit') {
        const spinner = document.getElementById('editSpinner');
        const buttonText = document.getElementById('editButtonText');
        const submitBtn = document.getElementById('editSubmitBtn');
        
        if (show) {
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'جاري التحديث...';
            submitBtn.disabled = true;
        } else {
            spinner.style.display = 'none';
            buttonText.textContent = 'تحديث';
            submitBtn.disabled = false;
        }
    }
}

// فتح نافذة الإضافة
function openAddModal() {
    document.getElementById('addForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('addModal'));
    modal.show();
}

// فتح نافذة التعديل
function openEditModal(id, name) {
    document.getElementById('editForm').reset();
    document.querySelector('#editForm input[name="id"]').value = id;
    document.querySelector('#editForm input[name="name"]').value = name;
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

// إرسال نموذج الإضافة
function submitAddForm(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    //const data = Object.fromEntries(formData);
    const data = {
        name: document.getElementById("add_name").value,
    };
    toggleLoading(true, 'add');
    
    axios.post("/document_types/add", data)
        .then(response => {
            if (response.data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                $('#documentTypesTable').bootstrapTable('refresh');
                showAlert('success', 'تمت العملية', 'تم إضافة نوع المستند بنجاح');
            } else {
                showAlert('error', 'خطأ', response.data.message || 'حدث خطأ أثناء الإضافة');
            }
        })
        .catch(error => {
            console.error("Error adding document type:", error);
            showAlert('error', 'خطأ', 'حدث خطأ أثناء إضافة نوع المستند');
        })
        .finally(() => {
            toggleLoading(false, 'add');
        });
}

// إرسال نموذج التعديل
function submitEditForm(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
   // const data = Object.fromEntries(formData);
    const id = document.getElementById("id").value;
      const data = {
        name: document.getElementById("edit_name").value,
        type_id:document.getElementById("id").value,
    };
    
    toggleLoading(true, 'edit');
    
    axios.post(`/document_types/update/${id}`, data)
        .then(response => {
            if (response.data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                $('#documentTypesTable').bootstrapTable('refresh');
                showAlert('success', 'تمت العملية', 'تم تعديل نوع المستند بنجاح');
            } else {
                showAlert('error', 'خطأ', response.data.message || 'حدث خطأ أثناء التحديث');
            }
        })
        .catch(error => {
            console.error("Error updating document type:", error);
            showAlert('error', 'خطأ', 'حدث خطأ أثناء تعديل نوع المستند');
        })
        .finally(() => {
            toggleLoading(false, 'edit');
        });
}

// تهيئة الجدول عند تحميل الصفحة
$(document).ready(function() {
    // إظهار مؤشر التحميل قبل تحميل الجدول
    toggleLoading(true, 'table');
    
    $('#documentTypesTable').bootstrapTable({
        onLoadSuccess: function(data) {
            toggleLoading(false, 'table');
        },
        onLoadError: function(status) {
            toggleLoading(false, 'table');
            showAlert('error', 'خطأ', 'حدث خطأ أثناء تحميل البيانات');
        }
    });
});

// معالجة الأحداث عند فتح النماذج
document.getElementById('addModal').addEventListener('show.bs.modal', function () {
    toggleLoading(false, 'add');
});

document.getElementById('editModal').addEventListener('show.bs.modal', function () {
    toggleLoading(false, 'edit');
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}