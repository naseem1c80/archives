{% extends "layouts/base.html" %}

{% block title %} Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚Ø§Øª {% endblock %} 

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
{% block title2 %} 
Ø¥Ø¯Ø§Ø±Ø© ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ğŸ“‚
{% endblock %} 


<section class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- Breadcrumb -->








        <!-- Form -->
        <form id="multi-form" enctype="multipart/form-data">
          

          
            <div class="card p-4 mx-auto mb-4" style="max-width: 800px;">
                <div class="row mb-3">
                                                <div class="mb-3 ">
                        <label for="document_type">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© </label>
                        <select class="form-select tag-select form-control"
                        id="document_type" name="document_type_id" >
<option value="id">Ø¨Ø·Ø§Ù‚Ø© Ø´Ø®ØµÙŠØ©</option>
<option value="passport">Ø¬ÙˆØ§Ø² Ø³ÙØ±</option>
<option value="familyId">Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø§Ø¦Ù„ÙŠØ©</option>

                        </select>

                    </div>
                  

                    <div class="col-md-4">
                        <label for="name"> 
                      Ø§Ù„Ø§Ø³Ù… 
                        </label>
                        <input type="text" name="name" class="form-control"
                        id="name"  required>
                    </div>

                    <div class="col-md-4">
                        <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="phone" name="phone" class="form-control"
                        id="phone" required>
                    </div>
           

<div class="text-end my-3">
                    <button type="button" class="btn btn-outline-primary" id="add-doc">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯</button>
                </div>

     </div>
                <!-- Ø·Ù„Ø¨ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ -->

                <!-- Documents Container -->
                <div id="documents-container" class="row mb-3">
                  
               
                  
                  
                  
                  
                  
                </div>





                <div class="d-grid">
                                   <div class="text-center">
                    <button type="submit" class="btn btn-scan mb-6">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚Ø§Øª</button>
                </div>
                </div>

                <div id="result_add" class="mt-4"></div>
            </div>
        </form>
    </div>
</section>
                
<!-- Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1"  style="display: none;" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    
     <div id="imageContainer" style="max-width: 600px; margin: auto;">
    <img id="imageToCrop"  style="max-width: 100%; display: block;">
  </div>                 
                    </div>
                <div class="modal-footer">
                    <button id="saveCropped" class="btn btn-success">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <style>
  #imageContainer {
    width: 100%;
    max-width: 100%;
    max-height: 80vh;
    overflow: hidden;
  }

  #imageToCrop {
    width: 100%;
    height: auto;
    display: block;
  }

  @media (max-width: 768px) {
    #imageContainer {
      max-height: 60vh;
    }
  }
</style>
    
    

<script>
    let cropper;
    const image = document.getElementById('imageToCrop');
   // const modal = new bootstrap.Modal(document.getElementById('cropModal'));
const modal = new bootstrap.Modal(document.getElementById('cropModal'));
    document.getElementById('cropModal').setAttribute('aria-hidden', 'true');
    document.getElementById('cropModal').addEventListener('shown.bs.modal', () => {
       /* cropper = new Cropper(image, {
         aspectRatio: NaN,           // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…Ø«Ù„Ø§Ù‹: 1 = Ù…Ø±Ø¨Ø¹ØŒ 16/9 = Ù…Ø³ØªØ·ÙŠÙ„)
    viewMode: 2,              // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶: 0 = Ø­Ø±ØŒ 1 = Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©ØŒ 2 = ØªØºØ·ÙŠØ©ØŒ 3 = Ù…Ù„Ø¡
    autoCropArea: 1,        // Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù‚ØªØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (0 Ø¥Ù„Ù‰ 1)
    movable: true,            // Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙˆØ±Ø©
    zoomable: true,           // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙƒØ¨ÙŠØ±
    rotatable: true,          // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ¯ÙˆÙŠØ±
    scalable: true,           // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØµØºÙŠØ± ÙˆØ§Ù„ØªÙƒØ¨ÙŠØ±
    responsive: true,         // Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
    cropBoxResizable: true,   // ØªÙ…ÙƒÙŠÙ† ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù‚Øµ
    dragMode: 'move',         // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø³Ø­Ø¨: crop Ø£Ùˆ move Ø£Ùˆ none
            
            
        });*/
        cropper = new Cropper(image, {
  viewMode: 1, // Ø£Ùˆ 2 Ù„Ø¶Ø¨Ø· Ø§Ù„ØªÙ…Ø¯Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
  autoCropArea: 1,
  responsive: true,
  scalable: true,
  zoomable: true,
  rotatable: true,
  movable: true,
  cropBoxResizable: true,
});
    });

    document.getElementById('cropModal').addEventListener('hidden.bs.modal', () => {
        cropper.destroy();
        cropper = null;
    });

    document.getElementById('saveCropped').addEventListener('click', () => {
      
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
         // alert(image.src);
         // alert(JSON.stringify(blob));
            const formData = new FormData();
            formData.append('cropped_image', blob);
formData.append('path', image.src);
            fetch('/save-cropped', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
              .then(data => {

              $(`textarea[name="docs[${index}][details]"]`).val(data['text']);

 $(`#file-upload-area-${index}`).addClass('d-none');
                document.getElementById(`file-path-${index}`).value=data['url'];
                document.getElementById(`img-${index}`).src=data['url'];
                //alert('Saved: ' + data);
                modal.hide();
            });
        });
    });
</script>


    
    
    
    
    
    
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

<script>
$(document).ready(function() {
    $('.tag-select').select2({
        tags: true, // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒØªØ§Ø¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        dir: "rtl",
        width: 'resolve',
        language: {
            noResults: function () {
                return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
            },
            searching: function () {
                return "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
            }
        }
    });
});
</script>




<script>
let docIndex = 0;
let index=0;

function createDocBlock(ind) {
    return `
    <div class="card p-4 mx-auto border shadow-sm rounded-3 mb-4 document-block col-md-6" style="max-width: 500px;">
        <h5 class="mb-3 fw-bold text-primary">ğŸ“„ ÙˆØ«ÙŠÙ‚Ø© Ø±Ù‚Ù… ${ind + 1}</h5>
        
                                <div class="form-group">
               
               <div class="btn-group">   
            <span class="btn btn-sm btn-outline-info" onclick="document.getElementById('file-input-${ind}').click()">
                ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù 
                   <i class="fas fa-cloud-upload-alt"></i> </span>

            
            <span class="btn btn-sm btn-outline-info" onclick="scan(${ind})">
            Ø§Ø³ÙƒØ§Ù†ÙŠØ±    
             <i class="fas fas fa-scanner"></i>
             <i class="fas fa-scanner-keyboard    "></i>
       ğŸ–¨ï¸
            </span>
            </div>
               
                                    <input type="text"
                                                id="file-path-${ind}" required
                                                readonly
                     name="docs[${ind}][path]" class="form-control"  required/>
                                <!-- Ø­Ù‚Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù†ÙØµÙ„ -->
                       <label><i class="fas fa-image"></i> ØµÙˆØ±Ø©</label>
                       <img id="img-${ind}"
                       
                       style="width:100%;"/>


                       <div class="ai-buttons-container">
    <!-- Ø²Ø± PyTesseract -->
    <div class="pytesseract-btn-wrapper">
        <button type="button" class="pytesseract-btn" onclick="startReadpytesseract(this, ${ind})" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PyTesseract">
            <i class="fas fa-font"></i>
            <span class="ai-tooltip">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ</span>
        </button>
    </div>
    
    <!-- Ø²Ø± Gemini AI -->
    <div class="gemini-btn-wrapper">
        <button type="button" class="gemini-btn" onclick="startReadGemini(this, ${ind})" title="   Gemini AI">
            <img src="static/assets/images/gemini-app-icon-hd.webp" alt="Gemini AI" class="gemini-icon">
            <span class="ai-tooltip">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</span>
        </button>
    </div>
</div>
                    <div class="file-upload-area" id="file-upload-area-${ind}" >
                        
                            <input type="file" id="file-input-${ind}"
                            accept="*/*" 
                            class="form-control d-none"
                            onchange="loadFilePreview(this,${ind})">
                   <i class="fas fa-cloud-upload-alt"></i>
                    <p>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
                   <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 2MB</small>

     
                  </div>



 <div class="mb-2 mt-4">
            <label class="form-label fw-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</label>
            <span class="btn btn-sm btn-outline-info" onclick="toggleDetails(1, this)">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
            <div class="progress mt-2 d-none" id="progress-${ind}">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progress-bar-${ind}">0%</div>
            </div>
            <div class="details_doc mt-2" style="display:none">
                <textarea name="docs[${ind}][details]" class="form-control mb-2" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ÙˆØµÙ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚..."></textarea>
                <pre id="pre-${ind}" class="bg-light p-2 rounded"></pre>
                <div id="pre2-${ind}" class="row" lass="bg-light p-2 rounded"></div>
            </div>
        </div>
<div id="result-${ind}"></div>



         </div>  
               
        
        <button type="button" class="btn btn-sm btn-danger mt-2 w-100 remove-doc">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button>
    </div>
    `;
}
function loadFilePreview(input,ind) {
    index=ind;
   // alert("loadFilePreview");
    const file = input.files[0];
    
uploadDocument(file, index);
   /* if (file && file.type.startsWith("image")) {
        const reader = new FileReader();
        reader.onload = function (e) {
                      $('#imageToCrop').attr('src',e.target.result);
            
            
        };
        reader.readAsDataURL(file);
    } else {
        
    }*/
}

function toggleDetails(index, btn) {
    const details = btn.closest(".card").querySelector(".details_doc");
    details.style.display = (details.style.display === 'none' || details.style.display === '') ? 'block' : 'none';
    btn.textContent = details.style.display === 'block' ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
}




// Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø©
$('#add-doc').on('click', function() {
    $('#documents-container').append(createDocBlock(docIndex));
    updateHandlers(); docIndex++;
});

// ÙØ­Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„


// Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ ÙˆØ«ÙŠÙ‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
$('#add-doc').click();



function show_details_doc(index, e) {
    const det = $(e).closest('.cdetails').find('.details_doc');
    det.slideToggle();
    $(e).text(det.is(':visible') ? '-' : '+');
}

function updateHandlers() {
    $('.source-select').off('change').on('change', function() {
        const index = $(this).data('index');
        const block = $(this).closest('.document-block');
        if ($(this).val() === 'upload') {
            block.find('.upload-block').removeClass('d-none');
            block.find(`#result-${index}`).addClass('d-none');
        } else {
            scan(index);
            block.find(`#result-${index}`).removeClass('d-none');
            block.find('.upload-block').addClass('d-none');
        }
    });

    $('.remove-doc').off('click').on('click', function() {
        $(this).closest('.document-block').remove();
    });
}

  

function scan(ind) {
    index=ind;
    $(`#result-${index}`).html('<div class="alert">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...</div>');
    $.ajax({ url: '/scan', type: 'POST', success: function(response) {
        if (response.success) {
             image.src = response.image_url;
             // $('#imageToCrop').attr('src',res.processed_image_path);
              modal.show();
             
            //$('#imageToCrop').attr('src',response.image_url);
            
        } else {
            $(`#result-${index}`).html('Ø®Ø·Ø£: ' + response.error);
        }
    }, error: function() {
        $(`#result-${index}`).html(`<div class="alert">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
        Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</div>`);
    }});
}

function uploadDocument(file=null, index2,path=null) {
  $(`#result-${index2}`).html(" ");
 // alert(index+'');
 $(`#progress-${index2}`).removeClass('d-none');
    const formData = new FormData();
    if(path!==null){
      formData.append('path', path);
    }else{
    formData.append('file', file);
    }
    const xhr = new XMLHttpRequest(); xhr.open('POST', '/read-doc', true);
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            $(`#progress-bar-${index2}`).css('width', percent + '%').text(percent + '%');
        }
    });
    xhr.onload = function() {
     // alert(index2+"/"+JSON.stringify(xhr)+"/"+xhr.status);
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
              image.src = res.processed_image_path;
             // $('#imageToCrop').attr('src',res.processed_image_path);
              modal.show();
            $(`#progress-${index2}`).addClass('d-none'); 
            }else{
              $(`#progress-${index2}`).addClass('d-none');
              $(`#result-${index2}`).html(`<div class="alert
              alert-danger">${res.message}</div>`);
            }
        } else {
            $(`#progress-${index2}`).addClass('d-none');
            $(`#result-${index2}`).html(`<div class="alert
              alert-danger">${xhr.status}</div>`);
        }
    };
    xhr.send(formData);
}


$('#multi-form').on('submit', function (e) {
    e.preventDefault();
   
    
    const formData = new FormData(this);
    $('#result').html('â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚Ø§Øª...');

    $.ajax({
        url: '/add_customer_doc',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
            if (res.success) {
                $('#result').html('<h5>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</h5>');
                $('#multi-form')[0].reset();
                $('#documents-container').empty();
                docIndex = 0;
            } else {
                $('#result').html('âŒ Ø®Ø·Ø£: ' + res.message);
            }
        },
        error: function () {
            $('#result').html('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });
});




function startReadGemini(e,index2){
    $(`#progress-${index2}`).removeClass('d-none');
 $(`#progress-bar-${index2}`).css('width', 0 + '%').text(0 + '%');
   const path=$(`input[name="docs[${index2}][path]"]`).val();//ile-path-${index}
    const formData = new FormData();
    
    if(path !== null){
        formData.append('path', path);
    } else {
        formData.append('file', file);
    }
    
    const xhr = new XMLHttpRequest(); 
    xhr.open('POST', '/gemini-ocr/upload', true);
    
    // Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            $(`#progress-bar-${index2}`).css('width', percent + '%').text(percent + '%');
        }
    });
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    xhr.onload = function() {
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
                $(`#progress-${index2}`).addClass('d-none');
                $(`#pre-${index2}`).html(res.text);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              //  convert(res.gemini_text);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                $(`#progress-${index2}`).addClass('d-none');
                
                // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
                $(`textarea[name="docs[${index2}][details]"]`).val(res.gemini_text);
               // $(`input[name="docs[${index}][path]"]`).val(res.processed_image_path);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                $(`#pre2-${index2}`).on('click', '.copy-badge', function () {
                    const text = $(this).data('text');
                    navigator.clipboard.writeText(text).then(() => {
                        const toast = new bootstrap.Toast(document.getElementById('toast-copy'));
                        toast.show();
                    }).catch(err => {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®');
                    });
                });
            }
        } else {
            console.error('ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯');
        }
    };
    xhr.send(formData);
}

function startReadpytesseract(e,index2){
    $(`#progress-${index2}`).removeClass('d-none');
 $(`#progress-bar-${index2}`).css('width', 0 + '%').text(0 + '%');
   const path=$(`input[name="docs[${index2}][path]"]`).val();//ile-path-${index}
    const formData = new FormData();
    
    if(path !== null){
        formData.append('path', path);
    } else {
        formData.append('file', file);
    }
    
    const xhr = new XMLHttpRequest(); 
    xhr.open('POST', '/read-doc', true);
    
    // Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            $(`#progress-bar-${index2}`).css('width', percent + '%').text(percent + '%');
        }
    });
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    xhr.onload = function() {
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
                $(`#progress-${index2}`).addClass('d-none');
                $(`#pre-${index2}`).html(res.text);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
               // convert(res.text);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                $(`#progress-${index2}`).addClass('d-none');
                
                // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
                $(`textarea[name="docs[${index2}][details]"]`).val(res.text);
               // $(`input[name="docs[${index}][path]"]`).val(res.processed_image_path);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                $(`#pre2-${index2}`).on('click', '.copy-badge', function () {
                    const text = $(this).data('text');
                    navigator.clipboard.writeText(text).then(() => {
                        const toast = new bootstrap.Toast(document.getElementById('toast-copy'));
                        toast.show();
                    }).catch(err => {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®');
                    });
                });
            }
        } else {
            console.error('ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯');
        }
    };
    xhr.send(formData);
}

</script>
<div id="toast-copy" class="toast position-fixed bottom-0 end-0 m-3 text-bg-success" role="alert" data-bs-delay="1500">
  <div class="toast-body">ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…</div>
</div>



<style>
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.ai-buttons-container {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
    z-index: 5;
}

/* ØªØµÙ…ÙŠÙ… Ø²Ø± Gemini AI */
.gemini-btn-wrapper {
    position: relative;
}

.gemini-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8e44ad, #9b59b6);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(142, 68, 173, 0.3);
    position: relative;
    overflow: hidden;
}

.gemini-btn:hover {
    background: linear-gradient(135deg, #7d3c98, #8e44ad);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(142, 68, 173, 0.4);
}

.gemini-btn.processing {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    animation: gemini-pulse 1.5s infinite;
}

.gemini-btn.processing:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
}

.gemini-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.gemini-btn:hover .gemini-icon {
    transform: scale(1.1);
}

.gemini-btn.processing .gemini-icon {
    animation: gemini-spin 2s linear infinite;
}

/* ØªØµÙ…ÙŠÙ… Ø²Ø± PyTesseract */
.pytesseract-btn-wrapper {
    position: relative;
}

.pytesseract-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
    position: relative;
    overflow: hidden;
    color: white;
}

.pytesseract-btn:hover {
    background: linear-gradient(135deg, #229954, #27ae60);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
}

.pytesseract-btn.processing {
    background: linear-gradient(135deg, #e67e22, #d35400);
    animation: pytesseract-pulse 1.5s infinite;
}

.pytesseract-btn.processing:hover {
    background: linear-gradient(135deg, #d35400, #ba4a00);
}

.pytesseract-btn i {
    font-size: 16px;
    transition: transform 0.3s ease;
}

.pytesseract-btn:hover i {
    transform: scale(1.1);
}

.pytesseract-btn.processing i {
    animation: pytesseract-bounce 1s infinite;
}

/* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes gemini-pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(142, 68, 173, 0.7);
    }
    70% { 
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(142, 68, 173, 0);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(142, 68, 173, 0);
    }
}

@keyframes pytesseract-pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    70% { 
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@keyframes gemini-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pytesseract-bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

/* Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª */
.ai-tooltip {
    position: absolute;
    bottom: -35px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 10;
    font-family: 'Cairo', sans-serif;
}

.gemini-btn:hover .ai-tooltip,
.pytesseract-btn:hover .ai-tooltip {
    opacity: 1;
    visibility: visible;
    bottom: -40px;
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.form-control.with-ai-buttons {
    padding-left: 100px;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„Ø²Ø±ÙŠÙ† */
.voice-ai-buttons-container {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
    z-index: 5;
}

/* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„ */
.mic-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.mic-btn:hover {
    background: linear-gradient(135deg, #5a6268, #3d4348);
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.mic-btn.recording {
    background: linear-gradient(135deg, #dc3545, #c82333);
    animation: mic-pulse 1.5s infinite;
}

.mic-btn.recording:hover {
    background: linear-gradient(135deg, #c82333, #a71e2a);
}

.mic-btn i {
    font-size: 16px;
}

@keyframes mic-pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% { 
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}
</style>

{% endblock %}
