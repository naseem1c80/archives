{% extends "layouts/base.html" %}

{% block title %} Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª {% endblock %} 

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<section class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- Breadcrumb -->
        <div class="page-header" dir="rtl">
            <h5 class="m-b-10">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ğŸ“‚</h5>
         
        </div>








        <!-- Form -->
        <form id="multi-form" enctype="multipart/form-data">
          

          
            <div class="card p-4 mx-auto mb-4" style="max-width: 800px;">
                <div class="row mb-3">
                                                <div class="mb-3 ">
                        <label for="document_type">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© </label>
                        <select class="form-select tag-select form-control"
                        id="document_type" name="document_type_id" >
<option value="id">Ø¨Ø·Ø§Ù‚Ø© Ø´Ø®ØµÙŠØ©</option>
<option value="passport">Ø¬ÙˆØ§Ø² Ø³ÙØ±</option>
<option value="familyId">Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø§Ø¦Ù„ÙŠØ©</option>

                        </select>

                    </div>
                  

                    <div class="col-md-4">
                        <label for="name"> 
                      Ø§Ù„Ø§Ø³Ù… 
                        </label>
                        <input type="text" name="name" class="form-control"
                        id="name"  required>
                    </div>

                    <div class="col-md-4">
                        <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="phone" name="phone" class="form-control"
                        id="phone" required>
                    </div>
           

<div class="text-end my-3">
                    <button type="button" class="btn btn-outline-primary" id="add-doc">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                </div>

     </div>
                <!-- Ø·Ù„Ø¨ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ -->

                <!-- Documents Container -->
                <div id="documents-container" class="row mb-3">
                  
               
                  
                  
                  
                  
                  
                </div>





                <div class="d-grid">
                                   <div class="text-center">
                    <button type="submit" class="btn btn-scan mb-6">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</button>
                </div>
                </div>

                <div id="result" class="mt-4"></div>
            </div>
        </form>
    </div>
</section>
                
<!-- Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1"  style="display: none;" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    
     <div id="imageContainer" style="max-width: 600px; margin: auto;">
    <img id="imageToCrop"  style="max-width: 100%; display: block;">
  </div>                 
                    </div>
                <div class="modal-footer">
                    <button id="saveCropped" class="btn btn-success">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <style>
  #imageContainer {
    width: 100%;
    max-width: 100%;
    max-height: 80vh;
    overflow: hidden;
  }

  #imageToCrop {
    width: 100%;
    height: auto;
    display: block;
  }

  @media (max-width: 768px) {
    #imageContainer {
      max-height: 60vh;
    }
  }
</style>
    
    

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
    let cropper;
    const image = document.getElementById('imageToCrop');
   // const modal = new bootstrap.Modal(document.getElementById('cropModal'));
const modal = new bootstrap.Modal(document.getElementById('cropModal'));
    document.getElementById('cropModal').setAttribute('aria-hidden', 'true');
    document.getElementById('cropModal').addEventListener('shown.bs.modal', () => {
       /* cropper = new Cropper(image, {
         aspectRatio: NaN,           // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…Ø«Ù„Ø§Ù‹: 1 = Ù…Ø±Ø¨Ø¹ØŒ 16/9 = Ù…Ø³ØªØ·ÙŠÙ„)
    viewMode: 2,              // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶: 0 = Ø­Ø±ØŒ 1 = Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©ØŒ 2 = ØªØºØ·ÙŠØ©ØŒ 3 = Ù…Ù„Ø¡
    autoCropArea: 1,        // Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù‚ØªØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (0 Ø¥Ù„Ù‰ 1)
    movable: true,            // Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙˆØ±Ø©
    zoomable: true,           // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙƒØ¨ÙŠØ±
    rotatable: true,          // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ¯ÙˆÙŠØ±
    scalable: true,           // ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØµØºÙŠØ± ÙˆØ§Ù„ØªÙƒØ¨ÙŠØ±
    responsive: true,         // Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
    cropBoxResizable: true,   // ØªÙ…ÙƒÙŠÙ† ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù‚Øµ
    dragMode: 'move',         // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø³Ø­Ø¨: crop Ø£Ùˆ move Ø£Ùˆ none
            
            
        });*/
        cropper = new Cropper(image, {
  viewMode: 1, // Ø£Ùˆ 2 Ù„Ø¶Ø¨Ø· Ø§Ù„ØªÙ…Ø¯Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
  autoCropArea: 1,
  responsive: true,
  scalable: true,
  zoomable: true,
  rotatable: true,
  movable: true,
  cropBoxResizable: true,
});
    });

    document.getElementById('cropModal').addEventListener('hidden.bs.modal', () => {
        cropper.destroy();
        cropper = null;
    });

    document.getElementById('saveCropped').addEventListener('click', () => {
      
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
         // alert(image.src);
         // alert(JSON.stringify(blob));
            const formData = new FormData();
            formData.append('cropped_image', blob);
formData.append('path', image.src);
            fetch('/save-cropped', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
              .then(data => {
                document.getElementById(`file-path-${index}`).value=data['url'];
                document.getElementById(`img-${index}`).src=data['url'];
                //alert('Saved: ' + data);
                modal.hide();
            });
        });
    });
</script>


    
    
    
    
    
    
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

<script>
$(document).ready(function() {
    $('.tag-select').select2({
        tags: true, // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒØªØ§Ø¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        dir: "rtl",
        width: 'resolve',
        language: {
            noResults: function () {
                return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
            },
            searching: function () {
                return "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
            }
        }
    });
});
</script>




<script>
let docIndex = 0;
let index=0;

function createDocBlock(ind) {
    return `
    <div class="card p-4 mx-auto border shadow-sm rounded-3 mb-4 document-block col-md-6" style="max-width: 500px;">
        <h5 class="mb-3 fw-bold text-primary">ğŸ“„ Ù…Ø³ØªÙ†Ø¯ Ø±Ù‚Ù… ${ind + 1}</h5>
        
                                <div class="form-group">
               
               <div class="btn-group">   
            <span class="btn btn-sm btn-outline-info" onclick="document.getElementById('file-input-${ind}').click()">
                ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù 
                   <i class="fas fa-cloud-upload-alt"></i> </span>

            
            <span class="btn btn-sm btn-outline-info" onclick="scan(${ind})">
            Ø§Ø³ÙƒØ§Ù†ÙŠØ±    
             <i class="fas fas fa-scanner"></i>
             <i class="fas fa-scanner-keyboard    "></i>
       ğŸ–¨ï¸
            </span>
            </div>
               
                                    <input type="text"
                                                id="file-path-${ind}" required
                                                readonly
                     name="docs[${ind}][path]" class="form-control"  required/>
                                <!-- Ø­Ù‚Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù†ÙØµÙ„ -->
                       <label><i class="fas fa-image"></i> ØµÙˆØ±Ø©</label>
                       <img id="img-${ind}"
                       
                       style="width:100%;"/>
                    <div class="file-upload-area"  >
                        
                            <input type="file" id="file-input-${ind}"
                            accept="*/*" 
                            class="form-control d-none"
                            onchange="loadFilePreview(this,${ind})">
                   <i class="fas fa-cloud-upload-alt"></i>
                    <p>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
                   <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 2MB</small>

     
                  </div>



 <div class="mb-2 mt-4">
            <label class="form-label fw-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
            <span class="btn btn-sm btn-outline-info" onclick="toggleDetails(1, this)">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
            <div class="progress mt-2 d-none" id="progress-${ind}">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progress-bar-${ind}">0%</div>
            </div>
            <div class="details_doc mt-2" style="display:none">
                <textarea name="docs[${ind}][details]" class="form-control mb-2" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ø³ØªÙ†Ø¯..."></textarea>
                <pre id="pre-${ind}" class="bg-light p-2 rounded"></pre>
                <div id="pre2-${ind}" class="row" lass="bg-light p-2 rounded"></div>
            </div>
        </div>




         </div>  
               
        
        <button type="button" class="btn btn-sm btn-danger mt-2 w-100 remove-doc">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯</button>
    </div>
    `;
}
function loadFilePreview(input,ind) {
    index=ind;
   // alert("loadFilePreview");
    const file = input.files[0];
    
uploadDocument(file, index);
   /* if (file && file.type.startsWith("image")) {
        const reader = new FileReader();
        reader.onload = function (e) {
                      $('#imageToCrop').attr('src',e.target.result);
            
            
        };
        reader.readAsDataURL(file);
    } else {
        
    }*/
}

function toggleDetails(index, btn) {
    const details = btn.closest(".card").querySelector(".details_doc");
    details.style.display = (details.style.display === 'none' || details.style.display === '') ? 'block' : 'none';
    btn.textContent = details.style.display === 'block' ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
}




// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯
$('#add-doc').on('click', function() {
    $('#documents-container').append(createDocBlock(docIndex));
    updateHandlers(); docIndex++;
});

// ÙØ­Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„


// Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø³ØªÙ†Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
$('#add-doc').click();



function show_details_doc(index, e) {
    const det = $(e).closest('.cdetails').find('.details_doc');
    det.slideToggle();
    $(e).text(det.is(':visible') ? '-' : '+');
}

function updateHandlers() {
    $('.source-select').off('change').on('change', function() {
        const index = $(this).data('index');
        const block = $(this).closest('.document-block');
        if ($(this).val() === 'upload') {
            block.find('.upload-block').removeClass('d-none');
            block.find(`#result-${index}`).addClass('d-none');
        } else {
            scan(index);
            block.find(`#result-${index}`).removeClass('d-none');
            block.find('.upload-block').addClass('d-none');
        }
    });

    $('.remove-doc').off('click').on('click', function() {
        $(this).closest('.document-block').remove();
    });
}

  

function scan(ind) {
    index=ind;
    $(`#result-${index} .alert`).html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...');
    $.ajax({ url: '/scan', type: 'POST', success: function(response) {
        if (response.success) {
             image.src = response.image_url;
             // $('#imageToCrop').attr('src',res.processed_image_path);
              modal.show();
             
            //$('#imageToCrop').attr('src',response.image_url);
            
        } else {
            $(`#result-${index} .alert`).html('Ø®Ø·Ø£: ' + response.error);
        }
    }, error: function() {
        $(`#result-${index} .alert`).html('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
    }});
}

function uploadDocument(file=null, index,path=null) {
 // alert(index+'');
 $(`#progress-${index}`).removeClass('d-none');
    const formData = new FormData();
    if(path!==null){
      formData.append('path', path);
    }else{
    formData.append('file', file);
    }
    const xhr = new XMLHttpRequest(); xhr.open('POST', '/read-doc', true);
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            $(`#progress-bar-${index}`).css('width', percent + '%').text(percent + '%');
        }
    });
    xhr.onload = function() {
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
              image.src = res.processed_image_path;
             // $('#imageToCrop').attr('src',res.processed_image_path);
              modal.show();
            $(`#progress-${index}`).addClass('d-none'); 
            }
        } else {
            $(`#progress-${index}`).addClass('d-none');
        }
    };
    xhr.send(formData);
}


$('#multi-form').on('submit', function (e) {
    e.preventDefault();
   
    
    const formData = new FormData(this);
    $('#result').html('â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª...');

    $.ajax({
        url: '/add_customer_doc',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
            if (res.success) {
                $('#result').html('<h5>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</h5>');
                $('#multi-form')[0].reset();
                $('#documents-container').empty();
                docIndex = 0;
            } else {
                $('#result').html('âŒ Ø®Ø·Ø£: ' + res.message);
            }
        },
        error: function () {
            $('#result').html('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });
});

</script>
<div id="toast-copy" class="toast position-fixed bottom-0 end-0 m-3 text-bg-success" role="alert" data-bs-delay="1500">
  <div class="toast-body">ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…</div>
</div>

{% endblock %}
