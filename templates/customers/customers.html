{% extends "layouts/base.html" %}

{% block title %} وثائق العملاء {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}

{% block title2 %} إدارة وثائق العملاء {% endblock %} 

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.4/dist/locale/bootstrap-table-ar-SA.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- [ Main Content ] start -->
<section class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ Main Content ] start -->
        <div class="row">
            <!-- [ basic-table ] start -->
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3" dir="rtl">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary font-weight-bold">قائمة وثائق العملاء</h5>
                           
                           
{% if current_user.has_permission("add_document_customer") %}
                            <a href="/add_customerdocument" class="btn btn-success d-flex align-items-center" target="_blank">
                                <i class="feather icon-plus me-2"></i>
                                إضافة مستند عميل
                            </a>

                    {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- فلترة البحث -->
                        <div class="search-box p-4 mb-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-gray-700 mb-2">بحث بالاسم</label>
                                    <input type="text" id="searchName" class="form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" 
                                           placeholder="ابحث باسم العميل...">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-gray-700 mb-2">بحث برقم الهاتف</label>
                                    <input type="text" id="searchPhone" class="form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" 
                                           placeholder="ابحث برقم الهاتف...">
                                </div>
                                
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="d-flex gap-2 w-100">
                                        <button class="btn btn-primary flex-grow-1" onclick="applyFilters()">
                                            <i class="feather icon-search me-2"></i>
                                            تطبيق البحث
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                            <i class="feather icon-refresh-cw me-2"></i>
                                            إعادة التعيين
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- مؤشر التحميل -->
                        <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2 text-muted">جاري تحميل البيانات...</p>
                        </div>

                        <div class="table-responsive">
                            <table
                                id="customersTable"
                                class="table table-striped table-bordered"
                                dir="rtl"
                                data-toggle="table"
                                data-ajax="ajaxRequest"
                                data-pagination="true"
                                data-side-pagination="server"
                                data-page-list="[10, 20, 50, 100]"
                                data-search="true"
                                data-search-align="right"
                                data-show-refresh="true"
                                data-show-toggle="true"
                                data-show-columns="true"
                                data-sort-name="id"
                                data-sort-order="desc"
                                data-locale="ar-SA">
                                
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="text-center py-2 px-3"
                                            data-field="id" 
                                            data-align="center"
                                            data-sortable="true">#</th>
                                        <th class="py-2 px-3"
                                            data-field="name" 
                                            data-sortable="true"
                                            data-align="right"
                                            data-formatter="nameFormatter">الاسم</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="phone" 
                                            data-sortable="true"
                                            data-align="center"
                                            data-formatter="phoneFormatter">رقم الهاتف</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="email" 
                                            data-sortable="true"
                                            data-align="center"
                                            data-formatter="emailFormatter">البريد الإلكتروني</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="documents_count" 
                                            data-sortable="true"
                                            data-align="center"
                                            data-formatter="documentsCountFormatter">عدد المستندات</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="created_at" 
                                            data-align="center"
                                            data-formatter="dateFormatter"
                                            data-sortable="true">تاريخ الإضافة</th>
                                        <th class="text-center py-2 px-3"
                                            data-align="center"
                                            data-formatter="actionsFormatter"
                                            data-events="actionsEvents"
                                            width="200px">الإجراءات</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</section>
<!-- [ Main Content ] end -->

<!-- Modal عرض العميل -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="customerModalLabel">تفاصيل العميل</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" id="customerModalBody">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">جاري تحميل بيانات العميل...</p>
                </div>
            </div>
            <div class="modal-footer border-top-0 bg-gray-50">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="button" class="btn btn-primary" onclick="printCustomerInfo()">
                    <i class="feather icon-printer me-2"></i>
                    طباعة
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal تأكيد الحذف -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">تأكيد الحذف</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد من حذف هذا العميل؟ سيتم حذف جميع البيانات المرتبطة به.</p>
                <input type="hidden" id="deleteCustomerId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">حذف</button>
            </div>
        </div>
    </div>
</div>

<script>
// المتغيرات العامة
let searchName = "";
let searchPhone = "";

// تهيئة الجدول
function actionsFormatter(value, row) {
    return [
        `<button class="btn btn-sm btn-outline-primary me-1" title="عرض التفاصيل">
            <i class="fas fa-eye"></i>
        </button>`,
        `<button class="btn btn-sm btn-outline-warning me-1" title="تعديل العميل">
            <i class="fas fa-edit"></i>
        </button>`,
        `<button class="btn btn-sm btn-outline-info me-1" title="مستندات العميل">
            <i class="fas fa-file-alt"></i>
        </button>`,
        `<button class="btn btn-sm btn-outline-danger" title="حذف العميل">
            <i class="fas fa-trash"></i>
        </button>`
    ].join('');
}

window.actionsEvents = {
    'click .btn-outline-primary': function (e, value, row, index) {
        viewCustomer(row.id);
    },
    'click .btn-outline-warning': function (e, value, row, index) {
        editCustomer(row.id);
    },
    'click .btn-outline-info': function (e, value, row, index) {
        viewCustomerDocuments(row.id);
    },
    'click .btn-outline-danger': function (e, value, row, index) {
        deleteCustomer(row.id);
    }
};

// Formatter functions
function nameFormatter(value, row) {
    return `
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 40px; height: 40px; font-size: 14px;">
                    ${value ? value.charAt(0).toUpperCase() : '?'}
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h6 class="mb-0 text-gray-800">${value || 'غير محدد'}</h6>
                <small class="text-muted">${row.company || ''}</small>
            </div>
        </div>
    `;
}

function phoneFormatter(value, row) {
    if (!value) {
        return `
            <span class="text-muted">غير محدد</span>
        `;
    }
    return `
        <div class="text-center">
            <a href="tel:${value}" class="text-decoration-none text-gray-700">
                <i class="fas fa-phone-alt me-2 text-primary"></i>
                ${value}
            </a>
        </div>
    `;
}

function emailFormatter(value, row) {
    if (!value) {
        return `
            <span class="text-muted">غير محدد</span>
        `;
    }
    return `
        <div class="text-center">
            <a href="mailto:${value}" class="text-decoration-none text-gray-700">
                <i class="fas fa-envelope me-2 text-primary"></i>
                ${value}
            </a>
        </div>
    `;
}

function documentsCountFormatter(value, row) {
    const count = value || 0;
    let badgeClass = 'bg-secondary';
    
    if (count > 0) {
        badgeClass = count > 5 ? 'bg-success' : 'bg-primary';
    }
    
    return `
        <span class="badge ${badgeClass} rounded-pill px-3 py-2">
            <i class="fas fa-file me-1"></i>
            ${count} مستند
        </span>
    `;
}

function dateFormatter(value, row, index) {
    if (!value) return '-';
    return `
        <div class="text-center">
            <div class="text-gray-800">${new Date(value).toLocaleDateString('ar-SA')}</div>
            <small class="text-muted">${new Date(value).toLocaleTimeString('ar-SA')}</small>
        </div>
    `;
}

// إظهار رسالة SweetAlert
function showAlert(icon, title, text) {
    Swal.fire({
        icon: icon,
        title: title,
        text: text,
        confirmButtonText: 'موافق',
        confirmButtonColor: '#3085d6',
        timer: icon === 'success' ? 3000 : null,
        timerProgressBar: icon === 'success'
    });
}

// إظهار/إخفاء مؤشر التحميل
function toggleLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    spinner.style.display = show ? 'block' : 'none';
}

// تطبيق الفلاتر
function applyFilters() {
    searchName = document.getElementById('searchName').value;
    searchPhone = document.getElementById('searchPhone').value;
    
    $('#customersTable').bootstrapTable('refresh');
}

// إعادة تعيين الفلاتر
function resetFilters() {
    searchName = "";
    searchPhone = "";
    
    document.getElementById('searchName').value = "";
    document.getElementById('searchPhone').value = "";
    
    $('#customersTable').bootstrapTable('refresh');
    showAlert('success', 'تمت العملية', 'تم إعادة تعيين الفلاتر بنجاح');
}

// AJAX Request للجدول
window.ajaxRequest = function (params) {
    if (!params.data) {
        params.data = {};
    }

    // إضافة الفلاتر
    if (searchName) {
        params.data['search_name'] = searchName;
    }
    if (searchPhone) {
        params.data['search_phone'] = searchPhone;
    }

    const url = "{{ url_for('customers_blueprint.getcustomers') }}";

    toggleLoading(true);

    $.get(`${url}?${$.param(params.data)}`)
        .then(function (res) {
            params.success(res);
            toggleLoading(false);
        })
        .catch(function (err) {
            console.error("Error fetching customers:", err);
            showAlert('error', 'خطأ', 'حدث خطأ أثناء تحميل البيانات');
            toggleLoading(false);
        });
};

// عرض تفاصيل العميل
function viewCustomer(id) {
    $('#customerModalBody').html(`
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">جاري تحميل بيانات العميل...</p>
        </div>
    `);
    
    $.get('/customer/' + id)
        .then(function (html) {
            $('#customerModalBody').html(html);
            $('#customerModal').modal('show');
        })
        .fail(function () {
            $('#customerModalBody').html(`
                <div class="alert alert-danger m-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    فشل في تحميل بيانات العميل
                </div>
            `);
        });
}

// تعديل العميل
function editCustomer(id) {
    window.open(`/edit_customer/${id}`, '_blank');
}

// عرض مستندات العميل
function viewCustomerDocuments(id) {
    window.open(`/customer_documents/${id}`, '_blank');
}

// حذف العميل
function deleteCustomer(id) {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: "سيتم حذف العميل وجميع المستندات المرتبطة به!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذفه!',
        cancelButtonText: 'إلغاء',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            toggleLoading(true);
            axios.post(`/customers/${id}/delete`)
                .then((response) => {
                    if (response.data.success) {
                        $('#customersTable').bootstrapTable('refresh');
                        showAlert('success', 'تم الحذف', 'تم حذف العميل بنجاح');
                    } else {
                        showAlert('error', 'خطأ', response.data.message || 'حدث خطأ أثناء الحذف');
                    }
                })
                .catch(error => {
                    console.error("Error deleting customer:", error);
                    showAlert('error', 'خطأ', 'حدث خطأ أثناء حذف العميل');
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }
    });
}

// طباعة معلومات العميل
function printCustomerInfo() {
    const printContent = document.getElementById('customerModalBody').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    $('#customersTable').bootstrapTable('refresh');
}

// البحث أثناء الكتابة (Debounce)
let searchTimeout;
function setupSearch() {
    $('#searchName, #searchPhone').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 500);
    });
}

// تهيئة الصفحة
$(document).ready(function() {
    $('#customersTable').bootstrapTable();
    setupSearch();
    
    // إضافة تأثيرات عند التحميل
    $('.card').hide().fadeIn(500);
    $('.search-box').hide().slideDown(600);
});

// إضافة فلترة بالضغط على Enter
$(document).on('keypress', '#searchName, #searchPhone', function(e) {
    if (e.which === 13) {
        applyFilters();
    }
});

// تحديث عدد العملاء تلقائياً
function refreshTable() {
    $('#customersTable').bootstrapTable('refresh');
    showAlert('info', 'تم التحديث', 'تم تحديث البيانات بنجاح');
}

// إضافة اختصارات لوحة المفاتيح
$(document).on('keydown', function(e) {
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshTable();
    }
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        window.open('/add_customerdocument', '_blank');
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}