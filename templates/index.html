<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f4f4; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 1rem; }
        .btn-scan { background-color: #198754; color: white; }
        .btn-scan:hover { background-color: #157347; }
        .preview { max-width: 100%; border-radius: 10px; margin-top: 15px; }
		
		.preview-box {
    border: 2px dashed #aaa;
    padding: 10px;
    text-align: center;
    margin-top: 10px;
    border-radius: 10px;
    background-color: #fff;
    max-height: 300px;
    overflow: auto;
}
.preview-box img {
    max-width: 100%;
    border-radius: 5px;
}

    </style>
</head>
<body>
<!--
<div class="container py-5">
    <div class="card p-4 mx-auto" style="max-width: 800px;">
        <h2 class="text-center mb-4">ğŸ“‚ Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h2>
        <form id="multi-form" enctype="multipart/form-data">
           
     <div class="mb-2">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
                <input type="text" name="doc_id" class="form-control" required>
            </div>

     <div class="mb-2">
                <label>Ø§Ù„Ø§Ø³Ù… </label>
                <input type="text" name="name" class="form-control" required>
            </div>
     <div class="mb-2">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØµØ¯Ø§Ø± </label>
                <input type="date" name="begin_date" class="form-control">
            </div>    

			<div class="mb-2">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ </label>
                <input type="date" name="end_date" class="form-control">
            </div>
			
			
		   <div id="documents-container">
                <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ --
				</div>
            <div class="text-end my-3">
                <button type="button" class="btn btn-outline-primary" id="add-doc">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-scan">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</button>
            </div>
        </form>
        <div id="result" class="mt-4"></div>
       
    </div>
</div>-->





<div class="container py-5">
  <form id="multi-form" enctype="multipart/form-data">
           
    <div class="card p-4 mx-auto" style="max-width: 800px;">
        <h2 class="text-center mb-4">ğŸ“‚ Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h2>
      
     <div class="mb-2">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
                <input type="text" name="doc_id" class="form-control" required>
            </div>

     <div class="mb-2">
                <label>Ø§Ù„Ø§Ø³Ù… </label>
                <input type="text" name="name" class="form-control" required>
            </div>
     <div class="mb-2">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØµØ¯Ø§Ø± </label>
                <input type="date" name="begin_date" class="form-control">
            </div>    

			<div class="mb-2">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ </label>
                <input type="date" name="end_date" class="form-control">
            </div>
			 </div>
			 
			
		   <div id="documents-container">
                <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            <div class="text-end my-3">
                <button type="button" class="btn btn-outline-primary" id="add-doc">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-scan">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</button>
            </div>
      
        <div id="result" class="mt-4"></div>
       
   
	  </form>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let docIndex = 0;
function createDocBlock(index) {
    return `  <div class="card p-4 mx-auto border rounded p-3 mb-4 document-block" style="max-width: 800px;">
        <div clas="border rounded p-3 mb-4 document-block">
            <h5 class="mb-3">Ù…Ø³ØªÙ†Ø¯ Ø±Ù‚Ù… ${index + 1}</h5>
       
            <div class="mb-2">
                <label>Ø§Ù„Ù…ØµØ¯Ø±</label>
                <select name="docs[${index}][source]" class="form-select source-select" data-index="${index}">
                    <option value="scan">Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</option>
                    <option value="upload">Ø±ÙØ¹ Ù…Ù„Ù</option>
                </select>
            </div>
            <div class="mb-2 upload-block d-none">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</label>
                <input type="file" onchange="loadfile(this)" name="docs[${index}][file]" class="form-control file-input" data-index="${index}">
            </div>
			 <div id="result-${index}" class="mt-4 d-none"><div class="alert"></div> <button onclick="scan(${index})">scan</button></div>
            <div class="preview-box" id="preview-${index}">
                <em class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯.</em>
            </div>
			
			    <div class="mb-2">
                <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
				 <div class="progress mt-2 d-none" id="progress-${index}">
        <div class="progress-bar" role="progressbar" style="width: 0%;" id="progress-bar-${index}">0%</div>
    </div>
                <textarea type="text" name="docs[${index}][details]"  class="form-control"></textarea>
            </div>
			
            <button type="button" class="btn btn-danger btn-sm remove-doc mt-2">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯</button>
        </div>
        </div>
    `;
}


function updateHandlers() {
    $('.source-select').off('change').on('change', function () {
        const index = $(this).data('index');
        const block = $(this).closest('.document-block');
        if ($(this).val() === 'upload') {
            block.find('.upload-block').removeClass('d-none');
			block.find(`#result-${index}`).addClass('d-none');
        } else {
		scan(index);
            block.find(`#result-${index}`).removeClass('d-none');
            block.find('.upload-block').addClass('d-none');
        }
    });

    $('.remove-doc').off('click').on('click', function () {
        $(this).closest('.document-block').remove();
    });
}

//$('.file-input').off('change').on('change', 
function  loadfile(f) {
	//alert(JSON.stringify(f)+"");
    const index =$(f).data('index'); 
    const file = f.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
		 $(`#progress-${index}`).removeClass('d-none');
            $(`#preview-${index}`).html(`<img src="${e.target.result}" alt="Preview">`);
			  //extractTextFromImage(file, index);
			  uploadDocument(file, index);
        };
        reader.readAsDataURL(file);
    }
}
//);

function extractTextFromImage(file, index) {
    const reader = new FileReader();
    reader.onload = function(e) {
        Tesseract.recognize(
            e.target.result,
            'ara', // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            {  logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        $(`#progress-bar-${index}`).css('width', `${pct}%`).text(`${pct}%`);
                    }
                }
            }
        
		
		
		).then(({ data: { text } }) => {
		$(`#progress-${index}`).addClass('d-none'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆØ§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            console.log("OCR Text:", text);
            const nameMatch = text.match(/Ø§Ù„Ø§Ø³Ù…[:\-]?\s*(.+)/);
            const idMatch = text.match(/Ø±Ù‚Ù…[:\-]?\s*(\d+)/);
console.log('idMatch',idMatch);
           $(`textarea[name="docs[${index}][details]"]`).val(text);
            if (nameMatch) $(`input[name="docs[${index}][name]"]`).val(nameMatch[1]);
            if (idMatch) $(`input[name="docs[${index}][id]"]`).val(idMatch[1]);
        }).catch(() => {
            $(`#progress-${index}`).addClass('d-none');
            alert("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù†Ø¯.");
        });
    };
    reader.readAsDataURL(file);
}



$('#add-doc').on('click', function () {
    $('#documents-container').append(createDocBlock(docIndex));
    updateHandlers();
    docIndex++;
});

$('#multi-form').on('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    $('#result').html('â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª...');

    $.ajax({
        url: '/save-docs',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
            if (res.success) {
                $('#result').html('<h5>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</h5>');
                $('#multi-form')[0].reset();
                $('#documents-container').empty();
                docIndex = 0;
            } else {
                $('#result').html('âŒ Ø®Ø·Ø£: ' + res.error);
            }
        },
        error: function () {
            $('#result').html('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });
});

// Ø£ÙˆÙ„ Ù…Ø³ØªÙ†Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
$('#add-doc').click();


function scan(index){
        $(`#result-${index}`).find('.alert').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...');

        $.ajax({
            url: '/scan',
            type: 'POST',
            data: {},  // Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
            success: function (response) {
                if (response.success) {
                    $('#result').html(`
                        <h5>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ğŸ–¼ï¸</h5>
                        <img src="${response.image_url}" class="preview">
                    `);
                } else {
                    $(`#result-${index}`).find('.alert').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $(`#result-${index}`).find('.alert').html('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });
    }
	
	
	
	
	
	
	function uploadDocument(file,index) {
 //   const fileInput = document.getElementById('doc-file');
   // const file = fileInput.files[0];

    if (!file) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø³Ù†Ø¯');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/read-doc', true);

    // Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù…
    xhr.upload.addEventListener('progress', function (e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
			 $(`#progress-bar-${index}`).css('width', `${percent}%`).text(`${percent}%`);
            //const progressBar = document.getElementById('uploadProgress');
            //progressBar.style.width = percent + '%';
           // progressBar.innerText = percent + '%';
        }
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    xhr.onload = function () {
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
			$(`#progress-${index}`).addClass('d-none');
			 $(`textarea[name="docs[${index}][details]"]`).val(res.text);
              //  document.getElementById('result').innerHTML = `<pre>${res.text}</pre>`;
            } else {
			$(`#progress-${index}`).addClass('d-none');
             //   document.getElementById('result').innerHTML = 'âŒ Ø®Ø·Ø£: ' + res.error;
            }
        } else {
		$(`#progress-${index}`).addClass('d-none');
           // document.getElementById('result').innerHTML = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.';
        }
    };

    xhr.onerror = function () {
	$(`#progress-${index}`).addClass('d-none');
        document.getElementById('result').innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
    };

    xhr.send(formData);
}
	
	
</script>
</body>
</html>


    <script>
	$(document).ready(function () {
    // Ø²Ø± Ø§Ù„Ø­ÙØ¸
    $('#scan-form').on('submit', function (e) {
        e.preventDefault();
        $('#result').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø­ÙØ¸...');

        $.ajax({
            url: '/scan_save',
            type: 'POST',
            data: $(this).serialize(),
            success: function (response) {
                if (response.success) {
                    $('#result').html(`
                        <h5>ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…</h5>
                        <p>Ø§Ù„Ø§Ø³Ù…: ${response.name}</p>
                        <p>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯: ${response.doc_id}</p>
                        <img src="${response.image_url}" class="preview">
                        <br><a href="${response.image_url}" download class="btn btn-outline-success mt-3">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</a>
                    `);
                } else {
                    $('#result').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $('#result').html('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.');
            }
        });
    });

    // Ø²Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    $('#view-btn').on('click', function () {
        $('#result').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...');

        $.ajax({
            url: '/scan',
            type: 'POST',
            data: {},  // Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
            success: function (response) {
                if (response.success) {
                    $('#result').html(`
                        <h5>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ğŸ–¼ï¸</h5>
                        <img src="${response.image_url}" class="preview">
                    `);
                } else {
                    $('#result').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $('#result').html('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });
    });
});
	</script>

