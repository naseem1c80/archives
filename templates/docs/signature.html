    <div class="signature-box mb-4">
        {% if document.is_signature %}
        {% if  document.signature!=None %}
            <p><strong>✅ تم التوقيع إلكترونيًا بواسطة المستخدم رقم {{ document.user_signature }}</strong></p>
            <textarea readonly rows="3" class="form-control">{{ document.signature }}</textarea>

        {% else %}
        
             {% if  document.user_signature== current_user.id%}
        
        <!-- حقل توقيع -->
<canvas id="signature-pad" width="400" height="200" style="border:1px solid #ccc;"></canvas>
<br>
<button id="saveSignatureBtn" class="btn btn-success mt-2">حفظ التوقيع</button>


<script>
    // إنشاء كائن توقيع
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);

    $('#saveSignatureBtn').click(function () {
        if (signaturePad.isEmpty()) {
            alert('يرجى توقيع المستند أولاً');
            return;
        }

        const signatureData = signaturePad.toDataURL();

        $.ajax({
            url: '/sign-document/{{ document.id }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ signature: signatureData }),
            success: function (response) {
                $('#signResult').html('<div class="alert alert-success">' + response.message + '</div>');
              //  setTimeout(() => location.reload(), 1500);
            },
            error: function () {
                $('#signResult').html('<div class="alert alert-danger">فشل في حفظ التوقيع</div>');
            }
        });
    });
</script>

        
        
            <p class="text-danger">⚠️ المستند غير موقع.</p>
            <button id="signBtn" class="btn btn-primary">توقيع إلكتروني</button>
            {% endif %}
        {% endif %}
        {% endif %}
        <div id="signResult" class="mt-2"></div>
    </div>






{% if current_user.has_permission("verify_document")
      and (not document.is_signature or document.signature)
%}

<div class="document-box mb-4">
    <label for="statusSelect"><strong>تغيير حالة المستند:</strong></label>
    <select id="statusSelect" class="form-control">
        <option value="0" {% if document.status == 0 %}selected{% endif %}>قيد المراجعة</option>
        <option value="1" {% if document.status == 1 %}selected{% endif %}>تم المراجعة</option>
        <option value="2" {% if document.status == 2 %}selected{% endif %}>مرتجع</option>
    </select>

    <div id="returnReasonDiv" class="mt-3" style="display: none;">
        <label for="returnReason">سبب الإرجاع:</label>
        <textarea id="returnReason" class="form-control" rows="3"></textarea>
    </div>

    <button id="saveStatusBtn" class="btn btn-primary mt-3">حفظ الحالة</button>
    <div id="statusMessage" class="mt-2"></div>
</div>

<script>
    $(document).ready(function () {
        function toggleReasonField() {
            const status = $('#statusSelect').val();
            $('#returnReasonDiv').toggle(status === '2');
        }

        toggleReasonField();
        $('#statusSelect').change(toggleReasonField);

        $('#saveStatusBtn').click(function () {
            const status = $('#statusSelect').val();
            const reason = $('#returnReason').val();

            if (status === '2' && reason.trim() === '') {
                alert('يرجى كتابة سبب الإرجاع');
                return;
            }

            $.ajax({
                url: '/update-document-status/{{ document.id }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ status: status, reason: reason }),
                success: function (response) {
                    $('#statusMessage').html('<div class="alert alert-success">' + response.message + '</div>');
                },
                error: function () {
                    $('#statusMessage').html('<div class="alert alert-danger">فشل في تحديث الحالة</div>');
                }
            });
        });
    });
</script>

{% endif %}