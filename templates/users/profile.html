{% extends "layouts/base.html" %}

{% block title %} الملف الشخصي {% endblock %}
{% block title2 %} الملف الشخصي {% endblock %}
{% block title3 %} {{ user.full_name }} {% endblock %}

{% block content %}

<style>
.profile-header {
    display: flex;
    gap: 20px;
    align-items: center;
}
.profile-header img {
    width:120px;height:120px;
    border-radius:50%;object-fit:cover;
}
.tab-btn {
    cursor:pointer;
    padding:5px 1px;
    border-radius:6px;
    margin-left:5px;
}
.tab-btn.active {
    background:#007bff;color:white;
    border:solid 0.2px #007bff;
}
.tab-content { display:none; }
.tab-content.active { display:block; }
.permission-badge {
    background:#e7f1ff;
    padding:5px 10px;
    border-radius:6px;
    margin:3px;
}
.log-item {
    border-bottom:1px solid #eee;
    padding:10px 0;
}
</style>

<div class="container mt-4">

    <!-- profile header -->
    <div class="profile-header mb-4">
        <img src="/get_imgae_user/{{user.id}}" alt="profile image">
        <div>
            <h3>{{ user.full_name }}</h3>
            <p class="text-muted">رقم الهاتف: {{ user.phone }}</p>
        </div>
    </div>

    <!-- TABS -->
    <div class="mb-3">
        <span class="tab-btn active" onclick="switchTab('info')">معلومات الموظف</span>
        <span class="tab-btn" onclick="switchTab('password')">تغيير كلمة المرور</span>
        <span class="tab-btn" onclick="switchTab('permissions')">الصلاحيات</span>
        <span class="tab-btn" onclick="switchTab('logs')">السجلات</span>
    </div>

    <!-- TAB 1: معلومات الموظف -->
    <div id="info" class="tab-content active card p-4">

        <form id="updateUserForm" onsubmit="updateUser(event)">
            <div class="mb-3">
                <label>اسم الموظف</label>
                <input class="form-control" name="full_name" value="{{user.full_name}}">
            </div>

            <div class="mb-3">
                <label>رقم الهاتف</label>
                <input class="form-control" name="phone" value="{{user.phone}}">
            </div>

            <button class="btn btn-primary">تحديث البيانات</button>
        </form>
    </div>

    <!-- TAB 2: تغيير كلمة المرور -->
    <div id="password" class="tab-content card p-4">

        <form onsubmit="changePassword(event)">
            <div class="mb-3">
                <label>كلمة المرور الجديدة</label>
                <input id="newPassword" class="form-control" type="password">
            </div>
            <div class="mb-3">
                <label>تأكيد كلمة المرور</label>
                <input id="confirmPassword" class="form-control" type="password">
            </div>

            <button class="btn btn-primary">تحديث كلمة المرور</button>
            <div id="msgPass" class="mt-2"></div>
        </form>

    </div>

    <!-- TAB 3: صلاحيات المستخدم -->
    <div id="permissions" class="tab-content card p-4">
        <h5>صلاحيات المستخدم</h5>

                    <div class="card-body">
                        <form id="permission-form" onsubmit="savePermission(event)">

                            
                            <div class="mb-4">
                                <label class="form-label fw-bold text-gray-700 mb-3">الصلاحيات المتاحة</label>
                                
                                <!-- فئة إدارة المستخدمين -->
                                <div class="permission-category">
                                    <h6><i class="fas fa-users me-2"></i>إدارة المستخدمين</h6>
                                    <div class="permission-grid">
                                        <div class="permission-item">
                                            <input type="checkbox" id="users" value="users">
                                            <label for="users">عرض المستخدمين</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="add_user" value="add_user">
                                            <label for="add_user">إضافة مستخدم</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="edit_user" value="edit_user">
                                            <label for="edit_user">تعديل المستخدمين</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="delete_user" value="delete_user">
                                            <label for="delete_user">حذف المستخدمين</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- فئة إدارة المستندات -->
                                <div class="permission-category">
                                    <h6><i class="fas fa-file-alt me-2"></i>إدارة المستندات</h6>
                                    <div class="permission-grid">
                                        <div class="permission-item">
                                            <input type="checkbox" id="add_document" value="add_document">
                                            <label for="add_document">إضافة مستند</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="edit_document" value="edit_document">
                                            <label for="edit_document">تعديل المستندات</label>
                                        </div>
                                        
                                                                            <div class="permission-item">
                                            <input type="checkbox"
                                            id="view_document"
                                            value="view_document">
                                            <label for="view_document">عرض  المستندات</label>
                                        </div>    
                                        
                                        
                                        <div class="permission-item">
                                            <input type="checkbox" id="delete_document" value="delete_document">
                                            <label for="delete_document">حذف المستندات</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="verify_document" value="verify_document">
                                            <label for="verify_document">التحقق من المستندات</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="approve_documents" value="approve_documents">
                                            <label for="approve-documents">اعتماد المستندات</label>
                                        </div>
                                    </div>
                                </div>



                                <!-- فئة إدارة المستندات -->
                                <div class="permission-category">
                                    <h6><i class="fas fa-file-alt me-2"></i>إدارة وثائق العملاء</h6>
                                    <div class="permission-grid">
                                        <div class="permission-item">
                                            <input type="checkbox" id="view_document_customers" value="view_document_customers">
                                            <label for="view_document_customers"> عرض الوثائق</label>
                                        </div>
                                      
                                        <div class="permission-item">
                                            <input type="checkbox" id="add_document_customer" value="add_document_customer">
                                            <label for="add_document_customer">إضافة وثيقة</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="edit_document_customer" value="edit_document_customer">
                                            <label for="edit_document_customer">تعديل وثيقة</label>
                                        </div>
                                        
                                                                            <div class="permission-item">
                                            <input type="checkbox"
                                            id="view_document_customer"
                                            value="view_document_customer">
                                            <label for="view_document_customer">عرض  وثيقة</label>
                                        </div>    
                                        
                                        
                                        <div class="permission-item">
                                            <input type="checkbox" id="delete_document_customer" value="delete_document_customer">
                                            <label for="delete_document_customer">حذف وثيقة</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="verify_document_customer" value="verify_document_customer">
                                            <label for="verify_document_customer">التحقق من وثيقة</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="approve_document_customer" value="approve_document_customer">
                                            <label for="approve-document_customer">اعتماد وثيقة</label>
                                        </div>
                                    </div>
                                </div>



                                <!-- فئة إدارة النظام -->
                                <div class="permission-category">
                                    <h6><i class="fas fa-cogs me-2"></i>إدارة النظام</h6>
                                    <div class="permission-grid">
                                         <div class="permission-item">
                                            <input type="checkbox" id="view_branchs" value="view_branchs">
                                            <label for="view_branchs">عرض الفروع</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="add_branch" value="add_branch">
                                            <label for="add_branch">إدارة الفروع</label>
                                        </div>


                                        <div class="permission-item">
                                            <input type="checkbox" id="edit_branch" value="edit_branch">
                                            <label for="edit_branch">تعديل الفروع</label>
                                        </div>

                                        <div class="permission-item">
                                            <input type="checkbox" id="add_document_types" value="add_document_types">
                                            <label for="add_document_types">إدارة أنواع المستندات</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="manage_archive" value="manage_archive">
                                            <label for="manage_archive">إدارة الأرشيف</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="manage_settings" value="manage_settings">
                                            <label for="manage-settings">إدارة الإعدادات</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- فئة التقارير والإحصائيات -->
                                <div class="permission-category">
                                    <h6><i class="fas fa-chart-bar me-2"></i>التقارير والإحصائيات</h6>
                                    <div class="permission-grid">
                                        <div class="permission-item">
                                            <input type="checkbox" id="view_reports" value="view_reports">
                                            <label for="view_reports">عرض التقارير</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" id="export_data" value="export_data">
                                            <label for="export_data">تصدير البيانات</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" id="save-permission-btn" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i>
                                    <span id="save-button-text">حفظ الصلاحية</span>
                                    <div id="save-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></div>
                                </button>
                                <button type="button" id="cancel-edit-btn" class="btn btn-outline-secondary px-4" style="display: none;" onclick="cancelEdit()">
                                    <i class="fas fa-times me-2"></i>
                                    إلغاء التعديل
                                </button>
                                <button type="button" class="btn btn-outline-info px-4" onclick="selectAllPermissions()">
                                    <i class="fas fa-check-square me-2"></i>
                                    تحديد الكل
                                </button>
                                <button type="button" class="btn btn-outline-warning px-4" onclick="deselectAllPermissions()">
                                    <i class="fas fa-times-circle me-2"></i>
                                    إلغاء الكل
                                </button>
                            </div>
                        </form>
                    </div>


    </div>

    <!-- TAB 4: السجلات -->
    <div id="logs" class="tab-content card p-4">

        <h5 class="mb-3">سجلات النشاط</h5>

        {% for log in user.activity_logs %}
        <div class="log-item">
            <strong>{{ log.action }}</strong> على جدول 
            <strong>{{ log.table_name }}</strong>
            <br>
            <small class="text-muted">{{ log.created_at }}</small>
            <br>
            <small class="text-muted">IP: {{ log.ip_address }} — {{ log.device_type }} — {{ log.browser }}</small>
        </div>
        {% endfor %}
    </div>

</div>
<!-- Modal عرض المستند -->

<script>
  

function switchTab(tab){
    document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(tabC => tabC.classList.remove("active"));

    event.target.classList.add("active");
    document.getElementById(tab).classList.add("active");
}

function changePassword(e){
    e.preventDefault();
    const p1 = newPassword.value;
    const p2 = confirmPassword.value;

    if(p1 !== p2){
        msgPass.innerHTML = "<div class='alert alert-danger'>كلمة المرور غير متطابقة</div>";
        return;
    }

    fetch("/update_password",{
        method:"POST",
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:`user_id={{user.id}}&new_password=${p1}`
    })
    .then(r=>r.json())
    .then(data=>{
        msgPass.innerHTML = `<div class='alert alert-success'>${data.message}</div>`;
    })
}
</script>
<script>
const userId = {{ user.id }};

// تحميل الصلاحيات عند فتح الصفحة
document.addEventListener("DOMContentLoaded", () =>{
//function getpermissions(id){
  //alert("5y");
    fetch(`/user/${userId}/permissions`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                const userPermissions = data.permissions;

                // تحديد المربعات حسب الصلاحيات
                userPermissions.forEach(p => {
                    const checkbox = document.querySelector(`input[value="${p}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        });
});


// حفظ الصلاحيات
function savePermission(event) {
    event.preventDefault();

    const checkboxes = document.querySelectorAll('.permission-item input[type="checkbox"]');
    let permissions = [];

    checkboxes.forEach(ch => {
        if (ch.checked) permissions.push(ch.value);
    });

    // إرسال البيانات للسيرفر
    fetch(`/user/${userId}/permissions`, {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ permissions: permissions })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            alert("تم حفظ صلاحيات المستخدم بنجاح");
        }
    });
}


// تحديد الكل
function selectAllPermissions() {
    document.querySelectorAll('.permission-item input[type="checkbox"]').forEach(cb => cb.checked = true);
}

// إلغاء الكل
function deselectAllPermissions() {
    document.querySelectorAll('.permission-item input[type="checkbox"]').forEach(cb => cb.checked = false);
}
</script>
<style>
.permission-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin-top: 10px;
}
.permission-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}
.permission-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}
.permission-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}
.permission-item label {
    margin: 0;
    cursor: pointer;
    font-weight: 500;
}
.permission-category {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}
.permission-category h6 {
    margin-bottom: 15px;
    color: #2c3e50;
    font-weight: 600;
}
</style>
{% endblock %}
