{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">
                                     إدارة المستخدمين  
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#"> إدارة المستخدمين  </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- [ basic-table ] start -->
                <div class="col-md-18">
                    <div class="card">
                        <div class="card-header">
                         

                                <div class="card-header d-flex justify-content-between align-items-center " dir="rtl">
    <h5>
                        إدارة المستخدمين   
                            </h5>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openAddModal()">إضافة مستخدم</button>
    </div>
                            <span class="d-block m-t-5">use class <code>table</code> inside table element</span>
                        </div>
                        <div class="card-body table-border-style">
                            <div class="table-responsive">
                             
      <table class="table table-bordered table-striped text-center"  dir="rtl">
        <thead class="table-success">
          <tr>
            <th>الاسم الكامل</th>
            <th>رقم الهاتف</th>
            <th>الصلاحية</th>
            <th>الحالة</th>
            <th>العمليات</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
   
                            </div>
                        </div>
                    </div>
                </div>
              
           
             
               
          
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="userForm" onsubmit="submitUser(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">إضافة مستخدم</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="userId">
          <div class="mb-3">
            <label>الاسم الكامل</label>
            <input type="text" id="full_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>رقم الهاتف</label>
            <input type="text" id="phone" class="form-control" required>
          </div>
          <div class="mb-3" id="passwordField">
            <label>كلمة المرور</label>
            <input type="password" id="password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>الصلاحية</label>
            <select id="role" class="form-control" required>
              <option value="admin">مدير</option>
              <option value="user">موظف</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="submit" class="btn btn-primary">حفظ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const userTable = document.getElementById("userTable");
  let currentId = null;

  function loadUsers() {
    axios.get("{{ url_for('users_blueprint.getusers') }}").then(res => {
      userTable.innerHTML = "";
      res.data.forEach(user => {
        userTable.innerHTML += `
          <tr>
            <td>${user.full_name}</td>
            <td>${user.phone}</td>
            <td>${user.role === 'admin' ? 'مدير' : 'موظف'}</td>
            <td>${user.active ? 'نشط' : 'مغلق'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="openEditModal(${user.id}, '${user.full_name}', '${user.phone}', '${user.role}')">تعديل</button>
              <button class="btn btn-sm btn-danger" onclick="disableUser(${user.id})">إغلاق</button>
            </td>
          </tr>
        `;
      });
    });
  }

  function openAddModal() {
    document.getElementById("modalTitle").innerText = "إضافة مستخدم";
    document.getElementById("userId").value = "";
    document.getElementById("full_name").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("password").value = "";
    document.getElementById("passwordField").style.display = "block";
    document.getElementById("role").value = "user";
  }

  function openEditModal(id, name, phone, role) {
    document.getElementById("modalTitle").innerText = "تعديل مستخدم";
    document.getElementById("userId").value = id;
    document.getElementById("full_name").value = name;
    document.getElementById("phone").value = phone;
    document.getElementById("role").value = role;
    document.getElementById("passwordField").style.display = "none";
    const modal = new bootstrap.Modal(document.getElementById("userModal"));
    modal.show();
  }

  function submitUser(e) {
    e.preventDefault();
    const id = document.getElementById("userId").value;
    const data = {
      full_name: document.getElementById("full_name").value,
      phone: document.getElementById("phone").value,
      role: document.getElementById("role").value,
    };
    if (!id) {
      data.password = document.getElementById("password").value;
      axios.post("/api/users", data).then(() => {
        bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
        loadUsers();
      });
    } else {
      axios.put(`/api/users/${id}`, data).then(() => {
        bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
        loadUsers();
      });
    }
  }

  function disableUser(id) {
    if (confirm("هل أنت متأكد من إغلاق هذا الحساب؟")) {
      axios.post(`/api/users/${id}/disable`).then(() => loadUsers());
    }
  }

  window.onload = loadUsers;
</script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
