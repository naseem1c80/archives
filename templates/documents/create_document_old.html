{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center" dir="rtl">
                        <div class="col-md-12">
                            <div class="page-header-title" >
                                <h5 class="m-b-10">
                                     Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª  ğŸ“‚
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª  </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- [ basic-table ] start -->
                <div class="col-md-18">
                   
                   
                   
                   
                   
                   
                   

    <link hre="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f4f4; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 1rem; }
        .btn-scan { background-color: #198754; color: white; }
        .btn-scan:hover { background-color: #157347; }
        .preview { max-width: 100%; border-radius: 10px; margin-top: 15px; }
		
		.preview-box {
    border: 2px dashed #aaa;
    padding: 10px;
    text-align: center;
    margin-top: 10px;
    border-radius: 10px;
    background-color: #fff;
    max-height: 300px;
    overflow: auto;
}
.preview-box img {
    max-width: 100%;
    border-radius: 5px;
}

    </style>






  <form id="multi-form" enctype="multipart/form-data">
           
    <div class="card p-4 mx-auto" style="max-width: 800px;">
        



 <div class="row mb-3">
      <div class="col-md-4">
        <label for="doc_id">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
        <input type="text" name="doc_id" class="form-control" id="doc_id">
      </div>
      <div class="col-md-4">
        <label for="transfer_number">Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø©</label>
        <input type="text" name="transfer_number" class="form-control" id="transfer_number">
      </div>

      <div class="col-md-4">
        <label for="sender_name">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„</label>
        <input type="text" name="sender_name" class="form-control" id="sender_name">
      </div>
      <div class="col-md-4">
        <label for="recipient_name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
        <input type="text" name="recipient_name" class="form-control" id="recipient_name">
      </div>
 

    <div class="col-md-4">
      <label for="date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯</label>
      <input type="date" name="date" class="form-control" id="date">
    </div>
   </div>








      

			 </div>
			 
			
		   <div id="documents-container" class="row mb-3">
                <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            <div class="text-end my-3">
                <button type="button" class="btn btn-outline-primary" id="add-doc">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
    <div class="text-center">
      <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
    </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-scan">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</button>
            </div>
      
        <div id="result" class="mt-4"></div>
       
   
	  </form>




<script>
let docIndex = 0;
function createDocBlock(index) {
    return `  <div class="card p-4 mx-auto border rounded p-3 mb-4 document-block col-md-6 " style="max-width: 500px;">
        <div clas="border rounded p-3 mb-4 document-block">
            <h5 class="mb-3">Ù…Ø³ØªÙ†Ø¯ Ø±Ù‚Ù… ${index + 1}</h5>
       
            <div class="mb-2">
                <label>Ø§Ù„Ù…ØµØ¯Ø±</label>
                <select name="docs[${index}][source]" class="form-select source-select" data-index="${index}">
                    <option value="scan">Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</option>
                    <option value="upload">Ø±ÙØ¹ Ù…Ù„Ù</option>
                </select>
            </div>
            <div class="mb-2 upload-block d-none">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</label>
                <input type="file" onchange="loadfile(this)" name="docs[${index}][file]" class="form-control file-input" data-index="${index}">
            </div>
			 <div id="result-${index}" class="mt-4 d-non"><div class="alert"></div> <span  class="btn btn-sm btn-primary " onclick="scan(${index})">scan</span></div>
            <div class="preview-box" id="preview-${index}">
                <em class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯.</em>
            </div>
			
			
			    <div class="mb-2 mt-4 cdetails">
                <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
			<span class="btn btn-sm btn-primary " id="show_details_doc" style="font-size:10px" onclick="show_details_doc(${index},this)">
		+
			</span>
				 <div class="progress mt-2 d-none" id="progress-${index}">
        <div class="progress-bar" role="progressbar" style="width: 0%;" id="progress-bar-${index}">0%</div>
    </div>
    <div class="details_doc" style="display:none">
                <textarea type="text" name="docs[${index}][details]"  class="form-control" colspan="10"></textarea>
            <pre id="pre-${index}"></pre>
                      <pre id="pre2-${index}"></pre>
                      
                      </div>
            </div>
			
            <button type="button" class="btn btn-danger btn-sm remove-doc mt-2">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯</button>
        </div>
        </div>
    `;
}


//$("#show_details_doc").click(
  function show_details_doc(index,e){
  var det=$(e).parents(".cdetails").find('.details_doc');
  if (det.is(':hidden')) {
    $(e).html("-");
    console.log('Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ');
} else {
  $(e).html("+");
    console.log('Ø§Ù„Ø¹Ù†ØµØ± Ø¸Ø§Ù‡Ø±');
}
  //if($(this).)
  det.slideToggle();
}
function updateHandlers() {
    $('.source-select').off('change').on('change', function () {
        const index = $(this).data('index');
        const block = $(this).closest('.document-block');
        if ($(this).val() === 'upload') {
            block.find('.upload-block').removeClass('d-none');
			block.find(`#result-${index}`).addClass('d-none');
        } else {
		scan(index);
            block.find(`#result-${index}`).removeClass('d-none');
            block.find('.upload-block').addClass('d-none');
        }
    });

    $('.remove-doc').off('click').on('click', function () {
        $(this).closest('.document-block').remove();
    });
}

//$('.file-input').off('change').on('change', 
function  loadfile(f) {
	//alert(JSON.stringify(f)+"");
    const index =$(f).data('index'); 
    const file = f.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
		 $(`#progress-${index}`).removeClass('d-none');
            $(`#preview-${index}`).html(`<img src="${e.target.result}" alt="Preview">`);
			 // extractTextFromImage(file, index);
			  uploadDocument(file, index);
        };
        reader.readAsDataURL(file);
    }
}
//);

function extractTextFromImage(file, index) {
    const reader = new FileReader();
    reader.onload = function(e) {
        Tesseract.recognize(
            e.target.result,
            'ara+en', // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            {  logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        $(`#progress-bar-${index}`).css('width', `${pct}%`).text(`${pct}%`);
                    }
                }
            }
        
		
		
		).then(({ data: { text } }) => {
		$(`#progress-${index}`).addClass('d-none'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆØ§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
           			$(`#pre2-${index}`).html(text);
            console.log("OCR Text:", text);
            const nameMatch = text.match(/Ø§Ù„Ø§Ø³Ù…[:\-]?\s*(.+)/);
            const idMatch = text.match(/Ø±Ù‚Ù…[:\-]?\s*(\d+)/);
console.log('idMatch',idMatch);
           $(`textarea[name="docs[${index}][details]"]`).val(text);
            if (nameMatch) $(`input[name="docs[${index}][name]"]`).val(nameMatch[1]);
            if (idMatch) $(`input[name="docs[${index}][id]"]`).val(idMatch[1]);
        }).catch(() => {
            $(`#progress-${index}`).addClass('d-none');
            alert("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù†Ø¯.");
        });
    };
    reader.readAsDataURL(file);
}



$('#add-doc').on('click', function () {
    $('#documents-container').append(createDocBlock(docIndex));
    updateHandlers();
    docIndex++;
});

$('#multi-form').on('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    $('#result').html('â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª...');

    $.ajax({
        url: '/save-docs',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
            if (res.success) {
                $('#result').html('<h5>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</h5>');
                $('#multi-form')[0].reset();
                $('#documents-container').empty();
                docIndex = 0;
            } else {
                $('#result').html('âŒ Ø®Ø·Ø£: ' + res.message);
            }
        },
        error: function () {
            $('#result').html('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });
});

// Ø£ÙˆÙ„ Ù…Ø³ØªÙ†Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
$('#add-doc').click();


function scan(index){
        $(`#result-${index}`).find('.alert').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...');

        $.ajax({
            url: '/scan',
            type: 'POST',
            data: {},  // Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
            success: function (response) {
                if (response.success) {
                    
            $(`#preview-${index}`).html(`<img src="${response.image_url}" alt="Preview">`);
                    /*$('#result').html(`
                        <h5>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ğŸ–¼ï¸</h5>

                        <img src="${response.image_url}" class="preview">
                    `);*/
                } else {
                    $(`#result-${index}`).find('.alert').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $(`#result-${index}`).find('.alert').html('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });
    }
	
	
	
	
	
	
	function uploadDocument(file,index) {
 //   const fileInput = document.getElementById('doc-file');
   // const file = fileInput.files[0];

    if (!file) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø³Ù†Ø¯');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/read-doc', true);

    // Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù…
    xhr.upload.addEventListener('progress', function (e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
			 $(`#progress-bar-${index}`).css('width', `${percent}%`).text(`${percent}%`);
            //const progressBar = document.getElementById('uploadProgress');
            //progressBar.style.width = percent + '%';
           // progressBar.innerText = percent + '%';
        }
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    xhr.onload = function () {
        if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
			$(`#progress-${index}`).addClass('d-none');
			$(`#pre-${index}`).html(res.text);
			convert(res.text);
			 $(`textarea[name="docs[${index}][details]"]`).val(res.text);
			 $(`#preview-${index}`).append(`<img src="${res.processed_image_path}" alt="Preview">`);
              //  document.getElementById('result').innerHTML = `<pre>${res.text.text}</pre>`;
            } else {
			$(`#progress-${index}`).addClass('d-none');
             //   document.getElementById('result').innerHTML = 'âŒ Ø®Ø·Ø£: ' + res.error;
            }
        } else {
		$(`#progress-${index}`).addClass('d-none');
           // document.getElementById('result').innerHTML = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.';
        }
    };

    xhr.onerror = function () {
	$(`#progress-${index}`).addClass('d-none');
        document.getElementById('result').innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
    };

    xhr.send(formData);
}
	
	
	
	function convert(text){
	  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªØ¹Ø§Ø¨ÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠØ©
const remittanceNumber = text.match(/Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø©\/\s*\|?\s*(\d+)/)?.[1] || "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
const senderName = text.match(/Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„\s*\/\s*[.|]?\s*(.+)/)?.[1]?.trim() || "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
const receiverName = text.match(/Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…\s*\/\s*[.|]?\s*(.+)/)?.[1]?.trim() || "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
const receiptNumber = text.match(/Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯\s*\/\s*(\d+)/)?.[1] || "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
const date = text.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})/)?.[1] || "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
transfer_number
            doc_id
            
            
            $("#sender_name").val(senderName);
            $("#recipient_name").val(receiverName);
            $("#transfer_number").val(remittanceNumber);
            $("#date").val(date);
            $("#doc_id").val(receiptNumber);
// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
console.log("Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø©:", remittanceNumber);
console.log("Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:", senderName);
console.log("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:", receiverName);
console.log("Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:", receiptNumber);
console.log("Ø§Ù„ØªØ§Ø±ÙŠØ®:", date);
	}
</script>
</body>
</html>


    <script>
	$(document).ready(function () {
    // Ø²Ø± Ø§Ù„Ø­ÙØ¸
    $('#scan-form').on('submit', function (e) {
        e.preventDefault();
        $('#result').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø­ÙØ¸...');

        $.ajax({
            url: '/scan_save',
            type: 'POST',
            data: $(this).serialize(),
            success: function (response) {
                if (response.success) {
                    $('#result').html(`
                        <h5>ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…</h5>
                        <p>Ø§Ù„Ø§Ø³Ù…: ${response.name}</p>
                        <p>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯: ${response.doc_id}</p>
                        <img src="${response.image_url}" class="preview">
                        <br><a href="${response.image_url}" download class="btn btn-outline-success mt-3">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</a>
                    `);
                } else {
                    $('#result').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $('#result').html('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.');
            }
        });
    });

    // Ø²Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    $('#view-btns').on('click', function () {
        $('#result').html('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·...');

        $.ajax({
            url: '/scan',
            type: 'POST',
            data: {},  // Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
            success: function (response) {
                if (response.success) {
                    $('#result').html(`
                        <h5>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ğŸ–¼ï¸</h5>
                        <img src="${response.image_url}" class="preview">
                    `);
                } else {
                    $('#result').html('Ø®Ø·Ø£: ' + response.error);
                }
            },
            error: function () {
                $('#result').html('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });
    });
});
	</script>


                   
                   
                   
                   
                   
                   
                   
                   

                
                
                </div>
              
           
             
               
          
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->



{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
