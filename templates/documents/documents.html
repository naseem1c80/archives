{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">
                                     إدارة المستندات  
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#"> إدارة المستندات  </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- [ basic-table ] start -->
                <div class="col-md-18">
                    <div class="card">
                        <div class="card-header">
                         

                                <div class="card-header d-flex justify-content-between align-items-center " dir="rtl">
    <h5>
                        إدارة المستندات   
                            </h5>
      <a href="/create_document" class="btn btn-success" target="_blank" onlick="openAddModal()">إضافة مستند</a>
    </div>
                           
                        </div>
                        <div class="card-body table-border-style">
                             
        <!-- فلترة البحث -->
        <div class="search-box p-3 mb-4">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="🔍 ابحث...">
                </div>
                <div class="col-md-2">
                    <select id="docType" class="form-select">
                        <option value="">كل الأنواع</option>
                        <option value="تقرير">تقرير</option>
                        <option value="عقد">عقد</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" id="docDate" class="form-control date-input">
                </div>
                <div class="col-md-2">
                    <select id="docStatus" class="form-select">
                        <option value="">كل الحالات</option>
                        <option value="1">متحقق</option>
                        <option value="0">غير متحقق</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync"></i> تحديث البيانات
                    </button>
                </div>
            </div>
        </div>



    <div class="table-responsive">
                        

      <table class="table table-bordered table-striped text-center"  dir="rtl" id="mainTable">
        <thead class="table-success">
          <tr>
            <th>الاسم </th>
            <th>رقم السند</th>
            <th>رقم الحوالة</th>
             <th> رقم الحساب</th>
            <th> المرسل</th>
             <th> المستلم</th>
            <th> الموظف</th>
            <th> الفرع</th>
            <th>الحالة</th>
                 <th>التاريخ</th>
            <th>العمليات</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
   
                            </div>
                        </div>
                    </div>
                </div>
              
           
             
               
          
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

     <script>
        // إعدادات التطبيق
        const appConfig = {
            apiUrl: "{{ url_for('documents_blueprint.getdocuments') }}",
            token: 'Bearer your_token_here',
            pageSize: 10
        };

        // تهيئة التطبيق
        $(document).ready(function() {
            initEventListeners();
            loadData();
        });

        // إدارة الأحداث
        function initEventListeners() {
            $('#refreshBtn').click(loadData);
            $('#searchInput').on('input', debounce(loadData, 300));
            $('.form-control, .form-select').change(loadData);
        }

        // تحميل البيانات
        function loadData() {
            showLoading();
            
            $.ajax({
                url: appConfig.apiUrl,
                type: 'GET',
                dataType: 'json',
                data: getFilters(),
                success: function(response) {
                    if(response.status === 'success') {
                        renderTable(response.data);
                    } else {
                        showError(response.message);
                    }
                },
                error: function(xhr) {
                    showError(xhr.responseJSON?.message || 'خطأ في الاتصال بالسيرفر');
                },
                complete: hideLoading
            });
        }

        // عرض البيانات في الجدول
        function renderTable(data) {
          //alert(JSON.stringify(data));
            const tbody = $('#mainTable tbody');
            tbody.empty();

            if(data.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            لا توجد بيانات متاحة
                        </td>
                    </tr>
                `);
                return;
            }

            data.forEach(doc => {
                tbody.append(`
                    <tr>
            <td>${doc.name}</td>
            <td>${doc.number_doc}</td>
            
            <td>${doc.transfer_number} </td>
             <td> ${doc.account_number} </td>
            <td> ${doc.sender_name}</td>
             <td> ${doc.recipient_name}</td>
            <td>${doc.user_name }</td>
            <td>${doc.branch_name }</td>
            <td>${doc.verify_user ? 'موثق' : 'تحت المراجعة'}</td>
           <td>${doc.created_at}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclic="openEditModal(${doc.id}, '${doc.name}', '${doc.number_doc}', '${doc.role}')">تعديل</button>
              <button class="btn btn-sm btn-danger" onclick="delete_document(${doc.id})">حذف</button>
            </td>
          </tr>
                `);
            });

            // إضافة أحداث الأزرار
            $('.view-btn').click(function() {
                const docId = $(this).data('id');
                viewDocument(docId);
            });
        }

        // معالجة الفلاتر
        function getFilters() {
            return {
                search: $('#searchInput').val(),
                type: $('#docType').val(),
                date: $('#docDate').val(),
                status: $('#docStatus').val(),
                limit: appConfig.pageSize
            };
        }

        // تنسيق التاريخ
        function formatDate(dateStr) {
            if(!dateStr) return 'بدون تاريخ';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // عرض التفاصيل
        function viewDocument(docId) {
            $.ajax({
                url: `${appConfig.apiUrl}/${docId}`,
                type: 'GET',
                headers: { 'Authorization': appConfig.token },
                success: function(doc) {
                    // يمكن إضافة عرض التفاصيل في مودال
                    alert(`تفاصيل الوثيقة: ${doc.name}\nالوصف: ${doc.description}`);
                }
            });
        }

        // إدارة التحميل
        function showLoading() {
            $('#loading').show();
        }

        function hideLoading() {
            $('#loading').hide();
        }

        // إدارة الأخطاء
        function showError(message) {
            $('#mainTable tbody').html(`
                <tr>
                    <td colspan="5" class="text-center text-danger py-4">
                        ⚠️ ${message}
                    </td>
                </tr>
            `);
        }

        // منع الطلبات المتكررة
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>

<script>
   function loadDatas() {
    axios.get("{{ url_for('documents_blueprint.getdocuments') }}").then(res => {
      userTable.innerHTML = "";
      res.data.forEach(user => {
        userTable.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.number_doc}</td>
            <td>${user.user_id }</td>
            <td>${user.verify_user ? 'موثق' : 'تحت المراجعة'}</td>
           <td>${user.created_at}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclic="openEditModal(${user.id}, '${user.name}', '${user.number_doc}', '${user.role}')">تعديل</button>
              <button class="btn btn-sm btn-danger" onclick="delete_document(${user.id})">حذف</button>
            </td>
          </tr>
        `;
      });
    });
  }
  

  function delete_document(id) {
    if (confirm("هل أنت متأكد من حذف هذا السند؟")) {
      axios.post(`/documents/${id}/delete`).then(() => loadData());
    }
  }

  window.onload = loadData;
</script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
