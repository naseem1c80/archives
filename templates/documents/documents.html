{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

  <script sr="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">
                                     إدارة المستندات  
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#"> إدارة المستندات  </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- [ basic-table ] start -->
                <div class="col-md-18">
                    <div class="card">
                        <div class="card-header">
                         

                                <div class="card-header d-flex justify-content-between align-items-center " dir="rtl">
    <h5>
                        إدارة المستندات   
                            </h5>
      <a href="/create_document" class="btn btn-success" target="_blank" onlick="openAddModal()">إضافة مستند</a>
    </div>
                           
                        </div>
                        <div class="card-body table-border-style">
                             
        <!-- فلترة البحث -->
        <div class="search-box p-3 mb-4">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="🔍 ابحث...">
                </div>
                <div class="col-md-2">
                    <select id="docType" class="form-select">
                        <option value="">كل الأنواع</option>
                        <option value="تقرير">تقرير</option>
                        <option value="عقد">عقد</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" id="docDate" class="form-control date-input">
                </div>
                <div class="col-md-2">
                    <select id="docStatus" class="form-select">
                        <option value="">كل الحالات</option>
                        <option value="1">متحقق</option>
                        <option value="0">غير متحقق</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync"></i> تحديث البيانات
                    </button>
                </div>
            </div>
        </div>



    <div class="table-responsive">
                        

<table class="table table-striped table-bordered" id="list"  
                               data-toggle="table"
                               data-url="{{
                               url_for('documents_blueprint.getdocuments') }}"
                               data-pagination="true"
                               data-side-pagination="server"
                               data-page-list="[10, 20, 30 , 40 , 50, 100, 200]"
                               data-search="true"
                               data-show-refresh="true"
                               data-show-toggle="true"
                               data-sort-name="id"
                               data-sort-order="asc">
                            <thead>
                            <tr>

     <!-- <table class="table table-bordered table-striped text-center"  dir="rtl" id="mainTable">
        <thead class="table-success">
          <tr>-->

							
                           
                                <th class="text-center py-1 px-2"
                                data-field="id" data-align="center"
                                data-sortable="true">ID</th>
                                

            <th  data-field="name" data-sortable="true">الاسم </th>
            <th data-field="number_doc" data-sortable="true">رقم السند</th>
            <th data-field="transfer_number" data-sortable="true">رقم الحوالة</th>
             <th data-field="account_number" data-sortable="true"> رقم الحساب</th>
            <th data-field="sender_name" data-align="center"
                                data-sortable="true"> المرسل</th>
             <th data-field="recipient_name" data-align="center"
                                data-sortable="true"> المستلم</th>
            <th data-field="user_name" data-align="center"
                                data-sortable="true"> الموظف</th>
            <th data-field="branch_name" data-align="center"
                                data-sortable="true"> الفرع</th>
            <th data-field="status" data-align="center" class="text-center py-1 px-2"
                                data-sortable="true">الحالة</th>
                 <th class="text-center py-1 px-2" data-field="created_at" data-align="center"
                                data-sortable="true">التاريخ</th>
<th data-align="center"     data-formatter="getactionuser"
data-events="actionEvents" width="100px"  class="text-center py-1 px-2"> action
</th>
						
                         
          </tr>
        </thead>
        <!--<tbody id="userTable"></tbody>-->
      </table>
   
   <!-- Pagination -->

    





<script>

    
    function getactionuser(value,row,index){
			    
			    return [`<div style="width:140px"><button class="btn btn-sm btn-primary"
			    onclic="openEditModal(${row['id']}, '${row['name']}', '${row['number_doc']}',
			    '${row['role']}')"> <i class="feather icon-edit"></i></button>
              <button class="btn btn-sm btn-danger"
              onclick="delete_document(${row['id']})"> <i class="feather icon-trash"></i></button> 
              <button class="btn btn-sm btn-success view-profile-btn" data-id="${row['id']}"   > <i class="feather icon-eye"></i></button></div>`];
			}
</script>


   
   
                            </div>
                        </div>
                    </div>
                </div>
              
           
             
               
          
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->

<!-- Modal -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="documentModalLabel">بروفايل المستند</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body" id="documentModalBody">
        <!-- يتم تحميل محتوى المستند هنا -->
        <div class="text-center p-4">جاري التحميل...</div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).on('click', '.view-profile-btn', function () {
    const docId = $(this).data('id');
    $('#documentModalBody').html('<div class="text-center p-4">جاري التحميل...</div>');

    $.get('/document/' + docId, function (html) {
        $('#documentModalBody').html(html);
        $('#documentModal').modal('show');
    }).fail(function () {
        $('#documentModalBody').html('<div class="alert alert-danger">فشل في تحميل البيانات</div>');
    });
});
</script>
    <script sr="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

     <script>
       
       let currentPage = 1;
    let limit = 10;
    let data = [];
    let sortBy = 'id';
    let sortOrder = 'asc'; // or 'desc'
        // إعدادات التطبيق
        const appConfig = {
            apiUrl: "{{ url_for('documents_blueprint.getdocuments') }}",
            token: 'Bearer your_token_here',
            pageSize: 10
        };

        // تهيئة التطبيق
        $(document).ready(function() {
            initEventListeners();
            loadData(1);
        });

        // إدارة الأحداث
        function initEventListeners() {
            $('#refreshBtn').click(loadData);
            $('#searchInput').on('input', debounce(function(){
              loadData(1);}, 300));
            $('.form-control, .form-select').change(function(){
              loadData(1);});
        }


        // عرض البيانات في الجدول
        function renderTable() {

        // معالجة الفلاتر
        function getFilters(offset=0) {
            return {
                search: $('#searchInput').val(),
                type: $('#docType').val(),
                date: $('#docDate').val(),
                status: $('#docStatus').val(),
                limit: limit,
                offset:offset,
                sort_by:sortBy,
                sort_order:sortOrder
            };
        }
        
        // إدارة التحميل
        function showLoading() {
            $('#loading').show();
        }

        function hideLoading() {
            $('#loading').hide();
        }

        // إدارة الأخطاء
        function showError(message) {
            $('#mainTable tbody').html(`
                <tr>
                    <td colspan="5" class="text-center text-danger py-4">
                        ⚠️ ${message}
                    </td>
                </tr>
            `);
        }

        // منع الطلبات المتكررة
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        function renderPagination(total, limit, currentPage) {
        const totalPages = Math.ceil(total / 10);
        const pagination = document.getElementById("paginationControls");
        pagination.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            const btn = document.createElement("button");
            btn.innerText = i;
            if (i === currentPage) btn.classList.add("active");
            btn.onclick = () => {
              loadData(i);
               // fetchDocuments(i);
            };
            li.appendChild(btn);
            pagination.appendChild(li);
        }
    }
    </script>

<script>
   
  

  function delete_document(id) {
    if (confirm("هل أنت متأكد من حذف هذا السند؟")) {
      axios.post(`/documents/${id}/delete`).then(() => loadData(1));
    }
  }

//  window.onload = loadData;
</script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
