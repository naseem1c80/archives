{% extends "layouts/base.html" %}

{% block title %} إدارة المستندات {% endblock %} 

<!-- Specific Page CSS goes HERE  -->


{% block content %}

{% block title2 %} 
  إدارة المستندات  
{% endblock %} 


<!-- [ Main Content ] start -->
<section class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ Main Content ] start -->
        <div class="row">
            <!-- [ basic-table ] start -->
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3" dir="rtl">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary font-weight-bold">قائمة المستندات</h5>
                            <a href="/create_document" class="btn btn-success d-flex align-items-center" target="_blank">
                                <i class="feather icon-plus me-2"></i>
                                إضافة مستند جديد
                            </a>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- فلترة البحث -->
                        <div class="search-box p-4 mb-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold text-gray-700 mb-2">نوع المستند</label>
                                    <select id="document_type" class="form-select form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                        <option value="0">كل الأنواع</option>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label fw-bold text-gray-700 mb-2">حالة المستند</label>
                                    <select id="docStatus" class="form-select form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                        <option value="">كل الحالات</option>
                                        <option value="1">متحقق</option>
                                        <option value="0">غير متحقق</option>
                                        <option value="2">مرتجع</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label fw-bold text-gray-700 mb-2">قابل للتوقيع </label>
                                    <select id="signatureStatus" class="form-select form-control border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                        <option value="">كل حالات التوقيع</option>
                                        <option value="true"> قابل للتوقيع</option>
                                        <option value="false">غير قابلة للتوقيع</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                        <i class="feather icon-refresh-cw me-2"></i>
                                        إعادة التعيين
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- مؤشر التحميل -->
                        <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2 text-muted">جاري تحميل البيانات...</p>
                        </div>

                        <div class="table-responsive">
                            <table
                                id="documentsTable"
                                class="table table-striped table-bordered"
                                dir="rtl"
                                data-toggle="table"
                                data-ajax="ajaxRequest"
                                data-pagination="true"
                                data-side-pagination="server"
                                data-page-list="[10, 20, 50, 100]"
                                data-search="true"
                                data-search-align="right"
                                data-show-refresh="true"
                                data-show-toggle="true"
                                data-show-columns="true"
                                data-sort-name="id"
                                data-sort-order="desc"
                                data-locale="ar-SA"
                                >
                                
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="text-center py-2 px-3"
                                            data-field="id" 
                                            data-align="center"
                                            data-sortable="true">#</th>
                                        <th class="py-2 px-3"
                                            data-field="type_document" 
                                            data-sortable="true"
                                            data-align="right">نوع المستند</th>
                                        <th class="py-2 px-3"
                                            data-field="name" 
                                            data-sortable="true"
                                            data-align="right">الاسم</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="number_doc" 
                                            data-sortable="true"
                                            data-align="center">رقم السند</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="transfer_number" 
                                            data-sortable="true"
                                            data-align="center">رقم الحوالة</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="signature" 
                                            data-align="center"
                                            data-formatter="signatureFormatter"
                                            data-sortable="true">حالة التوقيع</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="is_signature" 
                                            data-align="center"
                                            data-formatter="signatureAbilityFormatter"
                                            data-sortable="true">قابل للتوقيع</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="user_name" 
                                            data-sortable="true"
                                            data-align="center">الموظف</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="branch_name" 
                                            data-sortable="true"
                                            data-align="center">الفرع</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="status" 
                                            data-align="center"
                                            data-formatter="statusFormatter"
                                            data-sortable="true">الحالة</th>
                                        <th class="text-center py-2 px-3"
                                            data-field="created_at" 
                                            data-align="center"
                                            data-formatter="dateFormatter"
                                            data-sortable="true">التاريخ</th>
                                        <th class="text-center py-2 px-3"
                                            data-align="center"
                                            data-formatter="actionsFormatter"
                                            data-events="actionsEvents"
                                            width="180px">الإجراءات</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</section>
<!-- [ Main Content ] end -->

<!-- Modal عرض المستند -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="documentModalLabel">تفاصيل المستند</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" id="documentModalBody">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">جاري تحميل بيانات المستند...</p>
                </div>
            </div>
            <div class="modal-footer border-top-0 bg-gray-50">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="button" class="btn btn-primary" onclick="printDocument()">
                    <i class="feather icon-printer me-2"></i>
                    طباعة
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// المتغيرات العامة
let document_type = 0;
let document_status = "";
let is_signature = "";
let documents_type = [];

// تهيئة الجدول
function actionsFormatter(value, row) {
    return [
        `<button class="btn btn-sm btn-outline-primary me-1" title="عرض المستند">
            <i class="fas fa-eye"></i>
        </button>`,
        `<button class="btn btn-sm btn-outline-warning me-1" title="تعديل المستند">
            <i class="fas fa-edit"></i>
        </button>`,
        `<button class="btn btn-sm btn-outline-danger" title="حذف المستند">
            <i class="fas fa-trash"></i>
        </button>`
    ].join('');
}

window.actionsEvents = {
    'click .btn-outline-primary': function (e, value, row, index) {
        viewDocument(row.id);
    },
    'click .btn-outline-warning': function (e, value, row, index) {
        editDocument(row.id);
    },
    'click .btn-outline-danger': function (e, value, row, index) {
        deleteDocument(row.id);
    }
};

// Formatter functions
function signatureFormatter(value, row) {
    const st = row['is_signature'];
    const sig = row['signature'];
    
    if (!st) {
        return `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                <i class="fas fa-ban mr-1"></i>
                غير قابل للتوقيع
            </span>
        `;
    } else {
        if (sig) {
            return `
                <div class="text-center">
                    <img src="${sig}" width="120" height="40" class="border rounded" alt="التوقيع">
                    <div class="text-xs text-green-600 mt-1">تم التوقيع</div>
                </div>
            `;
        } else {
            return `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-clock mr-1"></i>
                    انتظار التوقيع
                </span>
            `;
        }
    }
}

function signatureAbilityFormatter(value, row) {
    const st = row['is_signature'];
    if (!st) {
        return `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                <i class="fas fa-times-circle mr-1"></i>
                غير مفعل
            </span>
        `;
    } else {
        return `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                <i class="fas fa-check-circle mr-1"></i>
                مفعل
            </span>
        `;
    }
}

function statusFormatter(value, row) {
    const st = row['status'];
    
    const statusConfig = {
        0: { class: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'clock', text: 'انتظار' },
        1: { class: 'bg-green-100 text-green-800 border-green-200', icon: 'check-circle', text: 'مكتمل' },
        2: { class: 'bg-red-100 text-red-800 border-red-200', icon: 'times-circle', text: 'مرتجع' }
    };
    
    const config = statusConfig[st] || statusConfig[0];
    
    return `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${config.class} border">
            <i class="fas fa-${config.icon} mr-1"></i>
            ${config.text}
        </span>
    `;
}

function dateFormatter(value, row, index) {
    if (!value) return '-';
    return new Date(value).toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// إظهار رسالة SweetAlert
function showAlert(icon, title, text) {
    Swal.fire({
        icon: icon,
        title: title,
        text: text,
        confirmButtonText: 'موافق',
        confirmButtonColor: '#3085d6',
    });
}

// إظهار/إخفاء مؤشر التحميل
function toggleLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    spinner.style.display = show ? 'block' : 'none';
}

// تحميل أنواع المستندات
async function loadDocumentTypes() {
    const doctypSelect = document.getElementById('document_type');
    
    try {
        if (documents_type.length < 1) {
            doctypSelect.innerHTML = '<option value="">جاري التحميل...</option>';
            const response = await fetch("{{ url_for('documents_blueprint.getdocument_types') }}");
            documents_type = await response.json();
        }
        
        doctypSelect.innerHTML = '<option value="0">كل الأنواع</option>';
        documents_type.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            doctypSelect.appendChild(option);
        });
    } catch (error) {
        doctypSelect.innerHTML = '<option value="">فشل التحميل</option>';
        console.error('خطأ في تحميل أنواع المستندات:', error);
    }
}

// فلترة البيانات
function change_document_type(e) {
    document_type = e.value;
    $('#documentsTable').bootstrapTable('refresh');
}

function change_document_status(e) {
    document_status = e.value;
    $('#documentsTable').bootstrapTable('refresh');
}

function change_signature_status(e) {
    is_signature = e.value;
    $('#documentsTable').bootstrapTable('refresh');
}


function resetFilters() {
    document_type = 0;
    document_status = "";
    is_signature = "";
    
    document.getElementById('document_type').value = "0";
    document.getElementById('docStatus').value = "";
    document.getElementById('signatureStatus').value = "";
    
    $('#documentsTable').bootstrapTable('refresh');
}

// AJAX Request للجدول
window.ajaxRequest = function (params) {
    if (!params.data) {
        params.data = {};
    }

    // إضافة الفلاتر
    if (document_type > 0) {
        params.data['document_type'] = document_type;
    }
    if (document_status) {
        params.data['status'] = document_status;
    }
    if (is_signature) {
        params.data['is_signature'] = is_signature;
    }

    const url = "{{ url_for('documents_blueprint.getdocuments') }}";

    toggleLoading(true);

    $.get(`${url}?${$.param(params.data)}`)
        .then(function (res) {
            params.success(res);
            toggleLoading(false);
        })
        .catch(function (err) {
            console.error("Error fetching documents:", err);
            showAlert('error', 'خطأ', 'حدث خطأ أثناء تحميل البيانات');
            toggleLoading(false);
        });
};

// عرض المستند
function viewDocument(id) {
    $('#documentModalBody').html(`
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">جاري تحميل بيانات المستند...</p>
        </div>
    `);
    
    $.get('/document/' + id)
        .then(function (html) {
            $('#documentModalBody').html(html);
            $('#documentModal').modal('show');
        })
        .fail(function () {
            $('#documentModalBody').html(`
                <div class="alert alert-danger m-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    فشل في تحميل بيانات المستند
                </div>
            `);
        });
}

// تعديل المستند
function editDocument(id) {
    window.open(`/edit_document/${id}`, '_blank');
}

// حذف المستند
function deleteDocument(id) {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: "لن تتمكن من التراجع عن هذا الإجراء!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذفه!',
        cancelButtonText: 'إلغاء',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            toggleLoading(true);
            axios.post(`/documents/${id}/delete`)
                .then(() => {
                    $('#documentsTable').bootstrapTable('refresh');
                    showAlert('success', 'تم الحذف', 'تم حذف المستند بنجاح');
                })
                .catch(error => {
                    console.error("Error deleting document:", error);
                    showAlert('error', 'خطأ', 'حدث خطأ أثناء حذف المستند');
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }
    });
}

// طباعة المستند
function printDocument() {
    const printContent = document.getElementById('documentModalBody').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    $('#documentsTable').bootstrapTable('refresh');
}

// تهيئة الصفحة
$(document).ready(function() {
    loadDocumentTypes();
    $('#documentsTable').bootstrapTable();
});

// إضافة فلترة حالة التوقيع
document.getElementById('document_type').addEventListener('change', function(e) {
    change_document_type(e.target);
});

document.getElementById('docStatus').addEventListener('change', function(e) {
    change_document_status(e.target);
});


document.getElementById('signatureStatus').addEventListener('change', function(e) {
    change_signature_status(e.target);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}