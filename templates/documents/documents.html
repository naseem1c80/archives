{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">
                                     Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª  
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª  </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- [ basic-table ] start -->
                <div class="col-md-18">
                    <div class="card">
                        <div class="card-header">
                         

                                <div class="card-header d-flex justify-content-between align-items-center " dir="rtl">
    <h5>
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª   
                            </h5>
      <a href="/create_document" class="btn btn-success" target="_blank" onlick="openAddModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯</a>
    </div>
                           
                        </div>
                        <div class="card-body table-border-style">
                             
        <!-- ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« -->
        <div class="search-box p-3 mb-4">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” Ø§Ø¨Ø­Ø«...">
                </div>
                <div class="col-md-2">
                    <select id="docType" class="form-select">
                        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="ØªÙ‚Ø±ÙŠØ±">ØªÙ‚Ø±ÙŠØ±</option>
                        <option value="Ø¹Ù‚Ø¯">Ø¹Ù‚Ø¯</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" id="docDate" class="form-control date-input">
                </div>
                <div class="col-md-2">
                    <select id="docStatus" class="form-select">
                        <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="1">Ù…ØªØ­Ù‚Ù‚</option>
                        <option value="0">ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </div>
        </div>



    <div class="table-responsive">
                        

      <table class="table table-bordered table-striped text-center"  dir="rtl" id="mainTable">
        <thead class="table-success">
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù… </th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø©</th>
             <th> Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
            <th> Ø§Ù„Ù…Ø±Ø³Ù„</th>
             <th> Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
            <th> Ø§Ù„Ù…ÙˆØ¸Ù</th>
            <th> Ø§Ù„ÙØ±Ø¹</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                 <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
   
                            </div>
                        </div>
                    </div>
                </div>
              
           
             
               
          
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

     <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const appConfig = {
            apiUrl: "{{ url_for('documents_blueprint.getdocuments') }}",
            token: 'Bearer your_token_here',
            pageSize: 10
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        $(document).ready(function() {
            initEventListeners();
            loadData();
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function initEventListeners() {
            $('#refreshBtn').click(loadData);
            $('#searchInput').on('input', debounce(loadData, 300));
            $('.form-control, .form-select').change(loadData);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function loadData() {
            showLoading();
            
            $.ajax({
                url: appConfig.apiUrl,
                type: 'GET',
                dataType: 'json',
                data: getFilters(),
                success: function(response) {
                    if(response.status === 'success') {
                        renderTable(response.data);
                    } else {
                        showError(response.message);
                    }
                },
                error: function(xhr) {
                    showError(xhr.responseJSON?.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                },
                complete: hideLoading
            });
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderTable(data) {
          //alert(JSON.stringify(data));
            const tbody = $('#mainTable tbody');
            tbody.empty();

            if(data.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©
                        </td>
                    </tr>
                `);
                return;
            }

            data.forEach(doc => {
                tbody.append(`
                    <tr>
            <td>${doc.name}</td>
            <td>${doc.number_doc}</td>
            
            <td>${doc.transfer_number} </td>
             <td> ${doc.account_number} </td>
            <td> ${doc.sender_name}</td>
             <td> ${doc.recipient_name}</td>
            <td>${doc.user_name }</td>
            <td>${doc.branch_name }</td>
            <td>${doc.verify_user ? 'Ù…ÙˆØ«Ù‚' : 'ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}</td>
           <td>${doc.created_at}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclic="openEditModal(${doc.id}, '${doc.name}', '${doc.number_doc}', '${doc.role}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-sm btn-danger" onclick="delete_document(${doc.id})">Ø­Ø°Ù</button>
            </td>
          </tr>
                `);
            });

            // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            $('.view-btn').click(function() {
                const docId = $(this).data('id');
                viewDocument(docId);
            });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
        function getFilters() {
            return {
                search: $('#searchInput').val(),
                type: $('#docType').val(),
                date: $('#docDate').val(),
                status: $('#docStatus').val(),
                limit: appConfig.pageSize
            };
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        function formatDate(dateStr) {
            if(!dateStr) return 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        function viewDocument(docId) {
            $.ajax({
                url: `${appConfig.apiUrl}/${docId}`,
                type: 'GET',
                headers: { 'Authorization': appConfig.token },
                success: function(doc) {
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„
                    alert(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©: ${doc.name}\nØ§Ù„ÙˆØµÙ: ${doc.description}`);
                }
            });
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoading() {
            $('#loading').show();
        }

        function hideLoading() {
            $('#loading').hide();
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        function showError(message) {
            $('#mainTable tbody').html(`
                <tr>
                    <td colspan="5" class="text-center text-danger py-4">
                        âš ï¸ ${message}
                    </td>
                </tr>
            `);
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>

<script>
   function loadDatas() {
    axios.get("{{ url_for('documents_blueprint.getdocuments') }}").then(res => {
      userTable.innerHTML = "";
      res.data.forEach(user => {
        userTable.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.number_doc}</td>
            <td>${user.user_id }</td>
            <td>${user.verify_user ? 'Ù…ÙˆØ«Ù‚' : 'ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}</td>
           <td>${user.created_at}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclic="openEditModal(${user.id}, '${user.name}', '${user.number_doc}', '${user.role}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-sm btn-danger" onclick="delete_document(${user.id})">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });
    });
  }
  

  function delete_document(id) {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ù†Ø¯ØŸ")) {
      axios.post(`/documents/${id}/delete`).then(() => loadData());
    }
  }

  window.onload = loadData;
</script>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
